/**
 * ç½‘ç»œè¯Šæ–­å·¥å…·
 * å¸®åŠ©ç”¨æˆ·å¿«é€Ÿå®šä½ç½‘ç»œè¿æ¥é—®é¢˜
 */

import http from '@ohos.net.http';
import { NetworkConfig } from '../config/NetworkConfig';
import { Logger } from './Logger';

export interface DiagnosticResult {
  success: boolean;
  message: string;
  details?: string[];
  suggestions?: string[];
}

export class NetworkDiagnostic {

  /**
   * æ‰§è¡Œå®Œæ•´çš„ç½‘ç»œè¯Šæ–­
   */
  public static async runFullDiagnostic(): Promise<DiagnosticResult[]> {
    Logger.network('å¼€å§‹æ‰§è¡Œç½‘ç»œè¯Šæ–­...');

    const results: DiagnosticResult[] = [];
    
    // 1. æ£€æŸ¥ç½‘ç»œé…ç½®
    results.push(await NetworkDiagnostic.checkNetworkConfig());
    
    // 2. æ£€æŸ¥åŸºç¡€è¿é€šæ€§
    results.push(await NetworkDiagnostic.checkBasicConnectivity());
    
    // 3. æ£€æŸ¥APIç«¯ç‚¹
    results.push(await NetworkDiagnostic.checkApiEndpoint());
    
    // 4. æ£€æŸ¥HTTPè¯·æ±‚
    results.push(await NetworkDiagnostic.checkHttpRequest());
    
    Logger.network('ç½‘ç»œè¯Šæ–­å®Œæˆ');
    return results;
  }
  
  /**
   * æ£€æŸ¥ç½‘ç»œé…ç½®
   */
  private static async checkNetworkConfig(): Promise<DiagnosticResult> {
    try {
      const baseUrl = NetworkConfig.getApiBaseUrl();
      const isLocalhost = baseUrl.includes('localhost') || baseUrl.includes('127.0.0.1');
      
      if (isLocalhost) {
        return {
          success: false,
          message: 'æ£€æµ‹åˆ°ä½¿ç”¨localhoståœ°å€',
          details: [
            `å½“å‰APIåœ°å€: ${baseUrl}`,
            'localhoståœ¨çœŸæœº/æ¨¡æ‹Ÿå™¨ä¸ŠæŒ‡å‘è®¾å¤‡æœ¬èº«ï¼Œæ— æ³•è®¿é—®å¼€å‘æœºå™¨'
          ],
          suggestions: [
            'è¯·åœ¨NetworkConfig.etsä¸­å°†DEV_SERVER_IPä¿®æ”¹ä¸ºå¼€å‘æœºå™¨çš„å®é™…IPåœ°å€',
            'Windows: å‘½ä»¤è¡Œè¾“å…¥ ipconfig æŸ¥çœ‹IPv4åœ°å€',
            'macOS/Linux: ç»ˆç«¯è¾“å…¥ ifconfig æŸ¥çœ‹inetåœ°å€'
          ]
        };
      }
      
      return {
        success: true,
        message: 'ç½‘ç»œé…ç½®æ£€æŸ¥é€šè¿‡',
        details: [`APIåœ°å€: ${baseUrl}`]
      };
    } catch (error) {
      return {
        success: false,
        message: 'ç½‘ç»œé…ç½®æ£€æŸ¥å¤±è´¥',
        details: [`é”™è¯¯: ${error}`]
      };
    }
  }
  
  /**
   * æ£€æŸ¥åŸºç¡€è¿é€šæ€§
   */
  private static async checkBasicConnectivity(): Promise<DiagnosticResult> {
    try {
      const httpRequest = http.createHttp();
      const baseUrl = NetworkConfig.getApiBaseUrl();
      const serverUrl = baseUrl.replace('/api/v1/records', '');
      
      const response = await httpRequest.request(serverUrl, {
        method: http.RequestMethod.GET,
        connectTimeout: 5000,
        readTimeout: 5000
      });
      
      httpRequest.destroy();
      
      if (response.responseCode === 200 || response.responseCode === 404) {
        return {
          success: true,
          message: 'æœåŠ¡å™¨è¿é€šæ€§æ£€æŸ¥é€šè¿‡',
          details: [`å“åº”ç : ${response.responseCode}`]
        };
      } else {
        return {
          success: false,
          message: 'æœåŠ¡å™¨å“åº”å¼‚å¸¸',
          details: [`å“åº”ç : ${response.responseCode}`],
          suggestions: ['æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ­£å¸¸è¿è¡Œ', 'æ£€æŸ¥ç«¯å£æ˜¯å¦å¼€æ”¾']
        };
      }
    } catch (error) {
      return {
        success: false,
        message: 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨',
        details: [`é”™è¯¯: ${error}`],
        suggestions: [
          'æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸',
          'ç¡®è®¤æœåŠ¡å™¨IPåœ°å€å’Œç«¯å£æ­£ç¡®',
          'æ£€æŸ¥é˜²ç«å¢™è®¾ç½®',
          'ç¡®è®¤æœåŠ¡å™¨å·²å¯åŠ¨'
        ]
      };
    }
  }
  
  /**
   * æ£€æŸ¥APIç«¯ç‚¹
   */
  private static async checkApiEndpoint(): Promise<DiagnosticResult> {
    try {
      const httpRequest = http.createHttp();
      const baseUrl = NetworkConfig.getApiBaseUrl();
      
      const response = await httpRequest.request(baseUrl, {
        method: http.RequestMethod.GET,
        header: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        connectTimeout: NetworkConfig.CONNECT_TIMEOUT,
        readTimeout: NetworkConfig.READ_TIMEOUT
      });
      
      httpRequest.destroy();
      
      if (response.responseCode === 200) {
        return {
          success: true,
          message: 'APIç«¯ç‚¹æ£€æŸ¥é€šè¿‡',
          details: [`å“åº”ç : ${response.responseCode}`]
        };
      } else {
        return {
          success: false,
          message: 'APIç«¯ç‚¹å“åº”å¼‚å¸¸',
          details: [
            `å“åº”ç : ${response.responseCode}`,
            `å“åº”å†…å®¹: ${response.result}`
          ],
          suggestions: [
            'æ£€æŸ¥APIè·¯å¾„æ˜¯å¦æ­£ç¡®',
            'ç¡®è®¤åç«¯æœåŠ¡APIæ¥å£å·²å®ç°',
            'æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—'
          ]
        };
      }
    } catch (error) {
      return {
        success: false,
        message: 'APIç«¯ç‚¹æ£€æŸ¥å¤±è´¥',
        details: [`é”™è¯¯: ${error}`],
        suggestions: [
          'æ£€æŸ¥APIè·¯å¾„é…ç½®',
          'ç¡®è®¤åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œ',
          'æ£€æŸ¥ç½‘ç»œè¿æ¥'
        ]
      };
    }
  }
  
  /**
   * æ£€æŸ¥HTTPè¯·æ±‚
   */
  private static async checkHttpRequest(): Promise<DiagnosticResult> {
    try {
      const httpRequest = http.createHttp();
      const baseUrl = NetworkConfig.getApiBaseUrl();
      
      // å°è¯•å‘é€ä¸€ä¸ªç®€å•çš„GETè¯·æ±‚
      const response = await httpRequest.request(`${baseUrl}?page=1&size=1`, {
        method: http.RequestMethod.GET,
        header: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        connectTimeout: NetworkConfig.CONNECT_TIMEOUT,
        readTimeout: NetworkConfig.READ_TIMEOUT
      });
      
      httpRequest.destroy();
      
      if (response.responseCode === 200) {
        try {
          JSON.parse(response.result as string);
          return {
            success: true,
            message: 'HTTPè¯·æ±‚æ£€æŸ¥é€šè¿‡',
            details: [
              `å“åº”ç : ${response.responseCode}`,
              `æ•°æ®æ ¼å¼: JSON`,
              `å“åº”å¤§å°: ${(response.result as string).length} å­—ç¬¦`
            ]
          };
        } catch (parseError) {
          return {
            success: false,
            message: 'HTTPè¯·æ±‚æˆåŠŸä½†æ•°æ®æ ¼å¼å¼‚å¸¸',
            details: [
              `å“åº”ç : ${response.responseCode}`,
              `è§£æé”™è¯¯: ${parseError}`,
              `å“åº”å†…å®¹: ${response.result}`
            ],
            suggestions: ['æ£€æŸ¥åç«¯APIè¿”å›çš„æ•°æ®æ ¼å¼']
          };
        }
      } else {
        return {
          success: false,
          message: 'HTTPè¯·æ±‚å¤±è´¥',
          details: [
            `å“åº”ç : ${response.responseCode}`,
            `å“åº”å†…å®¹: ${response.result}`
          ],
          suggestions: ['æ£€æŸ¥APIæ¥å£å®ç°', 'æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—']
        };
      }
    } catch (error) {
      return {
        success: false,
        message: 'HTTPè¯·æ±‚æ£€æŸ¥å¤±è´¥',
        details: [`é”™è¯¯: ${error}`],
        suggestions: [
          'æ£€æŸ¥ç½‘ç»œè¿æ¥',
          'ç¡®è®¤æœåŠ¡å™¨çŠ¶æ€',
          'æ£€æŸ¥è¯·æ±‚å‚æ•°'
        ]
      };
    }
  }
  
  /**
   * ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š
   */
  public static generateReport(results: DiagnosticResult[]): string {
    let report = '=== ç½‘ç»œè¯Šæ–­æŠ¥å‘Š ===\n\n';
    
    results.forEach((result, index) => {
      const status = result.success ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥';
      report += `${index + 1}. ${result.message} ${status}\n`;
      
      if (result.details && result.details.length > 0) {
        report += '   è¯¦æƒ…:\n';
        result.details.forEach(detail => {
          report += `   - ${detail}\n`;
        });
      }
      
      if (result.suggestions && result.suggestions.length > 0) {
        report += '   å»ºè®®:\n';
        result.suggestions.forEach(suggestion => {
          report += `   - ${suggestion}\n`;
        });
      }
      
      report += '\n';
    });
    
    const successCount = results.filter(r => r.success).length;
    const totalCount = results.length;
    report += `æ€»ç»“: ${successCount}/${totalCount} é¡¹æ£€æŸ¥é€šè¿‡\n`;
    
    if (successCount === totalCount) {
      report += 'ğŸ‰ æ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡äº†ï¼ç½‘ç»œè¿æ¥åº”è¯¥æ­£å¸¸ã€‚';
    } else {
      report += 'âš ï¸ å‘ç°é—®é¢˜ï¼Œè¯·æ ¹æ®ä¸Šè¿°å»ºè®®è¿›è¡Œæ’æŸ¥ã€‚';
    }
    
    return report;
  }
}