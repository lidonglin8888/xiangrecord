import { ApiService } from '../service/ApiService';
import { Logger } from '../utils/Logger';
import { UserManager, AppMode } from './UserModel';

// æ’æ³„ç‰©è®°å½•æ•°æ®æ¨¡å‹
export interface PoopRecord {
  id: number;
  userId?: string; // ç”¨æˆ·IDï¼Œè®¿å®¢æ¨¡å¼ä¸‹ä¸ºç©º
  date: Date;
  time: string;
  color: string; // é¢œè‰²
  smell: string; // æ°”å‘³
  moisture: string; // å¹²æ¹¿åº¦
  shape: string; // å½¢çŠ¶
  size: string; // å¤§å°
  texture: string; // è´¨åœ°
  notes?: string; // å¤‡æ³¨
  mood: string; // å¿ƒæƒ…
}

// é€‰é¡¹ç±»å‹å®šä¹‰
export interface ColorOption {
  value: string;
  label: string;
  color: string;
}

export interface SmellOption {
  value: string;
  label: string;
  emoji: string;
}

export interface MoistureOption {
  value: string;
  label: string;
  emoji: string;
}

export interface ShapeOption {
  value: string;
  label: string;
  emoji: string;
}

export interface SizeOption {
  value: string;
  label: string;
  emoji: string;
}

export interface TextureOption {
  value: string;
  label: string;
  emoji: string;
}

export interface MoodOption {
  value: string;
  label: string;
  emoji: string;
}

// é¢œè‰²é€‰é¡¹
export const COLOR_OPTIONS: ColorOption[] = [
  { value: 'brown', label: 'æ£•è‰²ğŸ¤', color: '#8B4513' },
  { value: 'yellow', label: 'é»„è‰²ğŸ’›', color: '#FFD700' },
  { value: 'green', label: 'ç»¿è‰²ğŸ’š', color: '#32CD32' },
  { value: 'black', label: 'é»‘è‰²ğŸ–¤', color: '#2F2F2F' },
  { value: 'red', label: 'çº¢è‰²â¤ï¸', color: '#FF4444' },
  { value: 'white', label: 'ç™½è‰²ğŸ¤', color: '#F5F5F5' }
];

// æ°”å‘³é€‰é¡¹
export const SMELL_OPTIONS: SmellOption[] = [
  { value: 'normal', label: 'æ­£å¸¸ğŸ˜Š', emoji: 'ğŸ˜Š' },
  { value: 'mild', label: 'è½»å¾®ğŸ˜', emoji: 'ğŸ˜' },
  { value: 'strong', label: 'æµ“çƒˆğŸ˜·', emoji: 'ğŸ˜·' },
  { value: 'sweet', label: 'ç”œå‘³ğŸ¯', emoji: 'ğŸ¯' },
  { value: 'sour', label: 'é…¸å‘³ğŸ‹', emoji: 'ğŸ‹' }
];

// å¹²æ¹¿åº¦é€‰é¡¹
export const MOISTURE_OPTIONS: MoistureOption[] = [
  { value: 'dry', label: 'å¹²ç‡¥ğŸœï¸', emoji: 'ğŸœï¸' },
  { value: 'normal', label: 'æ­£å¸¸ğŸ’§', emoji: 'ğŸ’§' },
  { value: 'wet', label: 'æ¹¿æ¶¦ğŸŒŠ', emoji: 'ğŸŒŠ' },
  { value: 'watery', label: 'æ°´æ ·ğŸ’¦', emoji: 'ğŸ’¦' }
];

// å½¢çŠ¶é€‰é¡¹
export const SHAPE_OPTIONS: ShapeOption[] = [
  { value: 'sausage', label: 'é¦™è‚ å‹ğŸŒ­', emoji: 'ğŸŒ­' },
  { value: 'lumpy', label: 'å—çŠ¶ğŸ§±', emoji: 'ğŸ§±' },
  { value: 'cracked', label: 'è£‚çº¹å‹ğŸª', emoji: 'ğŸª' },
  { value: 'soft', label: 'è½¯ç³ŠçŠ¶ğŸ¦', emoji: 'ğŸ¦' },
  { value: 'liquid', label: 'æ¶²ä½“çŠ¶ğŸ¥¤', emoji: 'ğŸ¥¤' },
  { value: 'pellets', label: 'é¢—ç²’çŠ¶ğŸ«˜', emoji: 'ğŸ«˜' }
];

// å¤§å°é€‰é¡¹
export const SIZE_OPTIONS: SizeOption[] = [
  { value: 'small', label: 'å°ğŸ¤', emoji: 'ğŸ¤' },
  { value: 'medium', label: 'ä¸­ç­‰ğŸ‘Œ', emoji: 'ğŸ‘Œ' },
  { value: 'large', label: 'å¤§ğŸ‘', emoji: 'ğŸ‘' },
  { value: 'huge', label: 'è¶…å¤§ğŸ¤¯', emoji: 'ğŸ¤¯' }
];

// è´¨åœ°é€‰é¡¹
export const TEXTURE_OPTIONS: TextureOption[] = [
  { value: 'smooth', label: 'å…‰æ»‘âœ¨', emoji: 'âœ¨' },
  { value: 'rough', label: 'ç²—ç³™ğŸª¨', emoji: 'ğŸª¨' },
  { value: 'soft', label: 'æŸ”è½¯ğŸ§¸', emoji: 'ğŸ§¸' },
  { value: 'hard', label: 'åšç¡¬ğŸ’', emoji: 'ğŸ’' },
  { value: 'sticky', label: 'ç²˜ç¨ ğŸ¯', emoji: 'ğŸ¯' }
];

// å¿ƒæƒ…é€‰é¡¹
export const MOOD_OPTIONS: MoodOption[] = [
  { value: 'happy', label: 'å¼€å¿ƒğŸ˜„', emoji: 'ğŸ˜„' },
  { value: 'normal', label: 'æ­£å¸¸ğŸ˜', emoji: 'ğŸ˜' },
  { value: 'tired', label: 'ç–²æƒ«ğŸ˜´', emoji: 'ğŸ˜´' },
  { value: 'uncomfortable', label: 'ä¸é€‚ğŸ˜£', emoji: 'ğŸ˜£' },
  { value: 'relieved', label: 'èˆ’ç•…ğŸ˜Œ', emoji: 'ğŸ˜Œ' },
  { value: 'worried', label: 'æ‹…å¿ƒğŸ˜°', emoji: 'ğŸ˜°' }
];

// è®°å½•ç®¡ç†ç±»
export class RecordManager {
  private static readonly STORAGE_KEY = 'poop_records';
  private static readonly API_MODE_KEY = 'api_mode';
  private static apiMode: boolean = false;

  // åˆå§‹åŒ–
  static init() {
    this.apiMode = AppStorage.get(this.API_MODE_KEY) as boolean || false;
  }

  // è®¾ç½®APIæ¨¡å¼
  static setApiMode(enabled: boolean) {
    this.apiMode = enabled;
    AppStorage.setOrCreate(this.API_MODE_KEY, enabled);
  }

  // è·å–APIæ¨¡å¼çŠ¶æ€
  static isApiMode(): boolean {
    return this.apiMode;
  }

  // æ£€æŸ¥APIè¿æ¥
  static async checkApiConnection(): Promise<boolean> {
    if (!this.apiMode) return true;
    
    try {
      return await ApiService.checkConnection();
    } catch (error) {
      Logger.error('RecordManager', 'æ£€æŸ¥APIè¿æ¥å¤±è´¥:', error);
      return false;
    }
  }

  // è·å–æ‰€æœ‰è®°å½•
  static async getAllRecords(): Promise<PoopRecord[]> {
    if (this.apiMode) {
      try {
        const userMode = UserManager.getCurrentMode();
        if (userMode === AppMode.GUEST) {
          // è®¿å®¢æ¨¡å¼ï¼Œä»æœ¬åœ°è·å–
          return this.getLocalRecords();
        } else {
          // ç™»å½•æ¨¡å¼ï¼Œä»APIè·å–
          const userId = UserManager.getCurrentUserId();
          if (userId) {
            return await ApiService.getRecords(userId);
          }
        }
      } catch (error) {
        Logger.error('RecordManager', 'ä»APIè·å–è®°å½•å¤±è´¥ï¼Œå›é€€åˆ°æœ¬åœ°:', error);
        return this.getLocalRecords();
      }
    }
    
    return this.getLocalRecords();
  }

  // ä»æœ¬åœ°å­˜å‚¨è·å–è®°å½•
  private static getLocalRecords(): PoopRecord[] {
    try {
      const recordsStr = AppStorage.get(this.STORAGE_KEY) as string;
      if (recordsStr) {
        const records = JSON.parse(recordsStr) as PoopRecord[];
        return records.map(record => ({
          ...record,
          date: new Date(record.date)
        })).sort((a, b) => b.date.getTime() - a.date.getTime());
      }
    } catch (error) {
      Logger.error('RecordManager', 'è§£ææœ¬åœ°è®°å½•å¤±è´¥:', error);
    }
    return [];
  }

  // ä¿å­˜è®°å½•åˆ°æœ¬åœ°
  private static saveLocalRecords(records: PoopRecord[]) {
    try {
      AppStorage.setOrCreate(this.STORAGE_KEY, JSON.stringify(records));
    } catch (error) {
      Logger.error('RecordManager', 'ä¿å­˜æœ¬åœ°è®°å½•å¤±è´¥:', error);
    }
  }

  // æ·»åŠ æ–°è®°å½•
  static async addRecord(record: Omit<PoopRecord, 'id'>): Promise<boolean> {
    try {
      const newRecord: PoopRecord = {
        ...record,
        id: Date.now() // ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºID
      };

      if (this.apiMode) {
        const userMode = UserManager.getCurrentMode();
        if (userMode !== AppMode.GUEST) {
          // ç™»å½•æ¨¡å¼ï¼Œä¿å­˜åˆ°API
          const userId = UserManager.getCurrentUserId();
          if (userId) {
            newRecord.userId = userId;
            const success = await ApiService.addRecord(newRecord);
            if (success) {
              return true;
            }
          }
        }
      }

      // ä¿å­˜åˆ°æœ¬åœ°
      const records = this.getLocalRecords();
      records.unshift(newRecord);
      this.saveLocalRecords(records);
      return true;
    } catch (error) {
      Logger.error('RecordManager', 'æ·»åŠ è®°å½•å¤±è´¥:', error);
      return false;
    }
  }

  // åˆ é™¤è®°å½•
  static async deleteRecord(id: number): Promise<boolean> {
    try {
      if (this.apiMode) {
        const userMode = UserManager.getCurrentMode();
        if (userMode !== AppMode.GUEST) {
          // ç™»å½•æ¨¡å¼ï¼Œä»APIåˆ é™¤
          const success = await ApiService.deleteRecord(id);
          if (success) {
            return true;
          }
        }
      }

      // ä»æœ¬åœ°åˆ é™¤
      const records = this.getLocalRecords();
      const filteredRecords = records.filter(record => record.id !== id);
      this.saveLocalRecords(filteredRecords);
      return true;
    } catch (error) {
      Logger.error('RecordManager', 'åˆ é™¤è®°å½•å¤±è´¥:', error);
      return false;
    }
  }

  // åŒæ­¥æ•°æ®åˆ°æœåŠ¡å™¨
  static async syncToServer(): Promise<boolean> {
    if (!this.apiMode) return true;
    
    try {
      const userMode = UserManager.getCurrentMode();
      if (userMode === AppMode.GUEST) return true;
      
      const userId = UserManager.getCurrentUserId();
      if (!userId) return false;
      
      const localRecords = this.getLocalRecords();
      const userRecords = localRecords.filter(record => !record.userId || record.userId === userId);
      
      for (const record of userRecords) {
        record.userId = userId;
        await ApiService.addRecord(record);
      }
      
      return true;
    } catch (error) {
      Logger.error('RecordManager', 'åŒæ­¥åˆ°æœåŠ¡å™¨å¤±è´¥:', error);
      return false;
    }
  }

  // ä»æœåŠ¡å™¨åŒæ­¥æ•°æ®
  static async syncFromServer(): Promise<boolean> {
    if (!this.apiMode) return true;
    
    try {
      const userMode = UserManager.getCurrentMode();
      if (userMode === AppMode.GUEST) return true;
      
      const userId = UserManager.getCurrentUserId();
      if (!userId) return false;
      
      const serverRecords = await ApiService.getRecords(userId);
      const localRecords = this.getLocalRecords();
      
      // åˆå¹¶è®°å½•ï¼Œé¿å…é‡å¤
      const mergedRecords = [...serverRecords];
      for (const localRecord of localRecords) {
        if (!serverRecords.find(r => r.id === localRecord.id)) {
          mergedRecords.push(localRecord);
        }
      }
      
      this.saveLocalRecords(mergedRecords);
      return true;
    } catch (error) {
      Logger.error('RecordManager', 'ä»æœåŠ¡å™¨åŒæ­¥å¤±è´¥:', error);
      return false;
    }
  }

  // è·å–ç»Ÿè®¡ä¿¡æ¯
  static async getStatistics(): Promise<{
    total: number;
    today: number;
    thisWeek: number;
    thisMonth: number;
    commonMood: string;
  }> {
    const records = await this.getAllRecords();
    const now = new Date();
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const weekStart = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);

    const todayRecords = records.filter(r => r.date >= today);
    const weekRecords = records.filter(r => r.date >= weekStart);
    const monthRecords = records.filter(r => r.date >= monthStart);

    // ç»Ÿè®¡æœ€å¸¸è§çš„å¿ƒæƒ…
    const moodCount: { [key: string]: number } = {};
    records.forEach(record => {
      moodCount[record.mood] = (moodCount[record.mood] || 0) + 1;
    });
    
    const commonMood = Object.keys(moodCount).reduce((a, b) => 
      moodCount[a] > moodCount[b] ? a : b, 'normal'
    );

    return {
      total: records.length,
      today: todayRecords.length,
      thisWeek: weekRecords.length,
      thisMonth: monthRecords.length,
      commonMood
    };
  }
}

// åˆå§‹åŒ–è®°å½•ç®¡ç†å™¨
RecordManager.init();