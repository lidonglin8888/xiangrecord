import { ApiService } from '../service/ApiService';
import { Logger } from '../utils/Logger';
import { UserManager, AppMode } from './UserModel';

// æ’æ³„ç‰©è®°å½•æ•°æ®æ¨¡å‹
export interface PoopRecord {
  id: number;
  userId?: string; // ç”¨æˆ·IDï¼Œè®¿å®¢æ¨¡å¼ä¸‹ä¸ºç©º
  date: Date;
  time: string;
  color: string; // é¢œè‰²
  smell: string; // æ°”å‘³
  moisture: string; // å¹²æ¹¿åº¦
  shape: string; // å½¢çŠ¶
  size: string; // å¤§å°
  texture: string; // è´¨åœ°
  notes?: string; // å¤‡æ³¨
  mood: string; // å¿ƒæƒ…
}

// é€‰é¡¹ç±»å‹å®šä¹‰
export interface ColorOption {
  value: string;
  label: string;
  color: string;
}

export interface SmellOption {
  value: string;
  label: string;
  emoji: string;
}

export interface MoistureOption {
  value: string;
  label: string;
  emoji: string;
}

export interface ShapeOption {
  value: string;
  label: string;
  emoji: string;
}

export interface SizeOption {
  value: string;
  label: string;
  emoji: string;
}

export interface TextureOption {
  value: string;
  label: string;
  emoji: string;
}

export interface MoodOption {
  value: string;
  label: string;
  emoji: string;
}

// é¢œè‰²é€‰é¡¹
export const COLOR_OPTIONS: ColorOption[] = [
  { value: 'brown', label: 'æ£•è‰²ğŸ¤', color: '#8B4513' },
  { value: 'yellow', label: 'é»„è‰²ğŸ’›', color: '#FFD700' },
  { value: 'green', label: 'ç»¿è‰²ğŸ’š', color: '#32CD32' },
  { value: 'black', label: 'é»‘è‰²ğŸ–¤', color: '#2F2F2F' },
  { value: 'red', label: 'çº¢è‰²â¤ï¸', color: '#FF4444' },
  { value: 'white', label: 'ç™½è‰²ğŸ¤', color: '#F5F5F5' }
];

// æ°”å‘³é€‰é¡¹
export const SMELL_OPTIONS: SmellOption[] = [
  { value: 'normal', label: 'æ­£å¸¸ğŸ˜Š', emoji: 'ğŸ˜Š' },
  { value: 'mild', label: 'è½»å¾®ğŸ˜', emoji: 'ğŸ˜' },
  { value: 'strong', label: 'æµ“çƒˆğŸ˜·', emoji: 'ğŸ˜·' },
  { value: 'sweet', label: 'ç”œå‘³ğŸ¯', emoji: 'ğŸ¯' },
  { value: 'sour', label: 'é…¸å‘³ğŸ‹', emoji: 'ğŸ‹' }
];

// å¹²æ¹¿åº¦é€‰é¡¹
export const MOISTURE_OPTIONS: MoistureOption[] = [
  { value: 'dry', label: 'å¹²ç‡¥ğŸœï¸', emoji: 'ğŸœï¸' },
  { value: 'normal', label: 'æ­£å¸¸ğŸ’§', emoji: 'ğŸ’§' },
  { value: 'wet', label: 'æ¹¿æ¶¦ğŸŒŠ', emoji: 'ğŸŒŠ' },
  { value: 'watery', label: 'æ°´æ ·ğŸ’¦', emoji: 'ğŸ’¦' }
];

// å½¢çŠ¶é€‰é¡¹
export const SHAPE_OPTIONS: ShapeOption[] = [
  { value: 'sausage', label: 'é¦™è‚ å‹ğŸŒ­', emoji: 'ğŸŒ­' },
  { value: 'lumpy', label: 'å—çŠ¶ğŸ§±', emoji: 'ğŸ§±' },
  { value: 'cracked', label: 'è£‚çº¹å‹ğŸª', emoji: 'ğŸª' },
  { value: 'soft', label: 'è½¯ç³ŠçŠ¶ğŸ¦', emoji: 'ğŸ¦' },
  { value: 'liquid', label: 'æ¶²ä½“çŠ¶ğŸ¥¤', emoji: 'ğŸ¥¤' },
  { value: 'pellets', label: 'é¢—ç²’çŠ¶ğŸ«˜', emoji: 'ğŸ«˜' }
];

// å¤§å°é€‰é¡¹
export const SIZE_OPTIONS: SizeOption[] = [
  { value: 'small', label: 'å°ğŸ­', emoji: 'ğŸ­' },
  { value: 'medium', label: 'ä¸­ğŸ°', emoji: 'ğŸ°' },
  { value: 'large', label: 'å¤§ğŸ»', emoji: 'ğŸ»' },
  { value: 'extra_large', label: 'è¶…å¤§ğŸ¦£', emoji: 'ğŸ¦£' }
];

// è´¨åœ°é€‰é¡¹
export const TEXTURE_OPTIONS: TextureOption[] = [
  { value: 'smooth', label: 'å…‰æ»‘âœ¨', emoji: 'âœ¨' },
  { value: 'rough', label: 'ç²—ç³™ğŸª¨', emoji: 'ğŸª¨' },
  { value: 'sticky', label: 'ç²˜ç¨ ğŸ¯', emoji: 'ğŸ¯' },
  { value: 'fluffy', label: 'è“¬æ¾â˜ï¸', emoji: 'â˜ï¸' }
];

// å¿ƒæƒ…é€‰é¡¹
export const MOOD_OPTIONS: MoodOption[] = [
  { value: 'happy', label: 'å¼€å¿ƒğŸ˜„', emoji: 'ğŸ˜„' },
  { value: 'relieved', label: 'èˆ’ç•…ğŸ˜Œ', emoji: 'ğŸ˜Œ' },
  { value: 'normal', label: 'ä¸€èˆ¬ğŸ˜', emoji: 'ğŸ˜' },
  { value: 'uncomfortable', label: 'ä¸é€‚ğŸ˜£', emoji: 'ğŸ˜£' },
  { value: 'painful', label: 'ç—›è‹¦ğŸ˜–', emoji: 'ğŸ˜–' }
];


// æ•°æ®å­˜å‚¨ç®¡ç†ç±»
export class RecordManager {
  private static readonly GUEST_STORAGE_KEY = 'guest_poop_records';
  private static readonly CLOUD_STORAGE_KEY = 'cloud_poop_records';
  private static readonly USE_API_KEY = 'use_api_mode';
  private static readonly SYNC_STATUS_KEY = 'sync_status';
  
  // è·å–å½“å‰æ¨¡å¼å¯¹åº”çš„å­˜å‚¨é”®
  private static getStorageKey(): string {
    return UserManager.isGuestMode() ? RecordManager.GUEST_STORAGE_KEY : RecordManager.CLOUD_STORAGE_KEY;
  }

  // è·å–æ˜¯å¦ä½¿ç”¨APIæ¨¡å¼
  static isApiMode(): boolean {
    return AppStorage.get<boolean>(RecordManager.USE_API_KEY) || false;
  }

  // è®¾ç½®APIæ¨¡å¼
  static setApiMode(useApi: boolean): void {
    AppStorage.setOrCreate(RecordManager.USE_API_KEY, useApi);
  }

  // è·å–æœ¬åœ°è®°å½•
  static getLocalRecords(): PoopRecord[] {
    try {
      const storageKey = RecordManager.getStorageKey();
      const recordsStr = AppStorage.get<string>(storageKey) || '[]';
      const records = JSON.parse(recordsStr) as PoopRecord[];
      // è½¬æ¢æ—¥æœŸå­—ç¬¦ä¸²ä¸ºDateå¯¹è±¡
      return records.map(record => {
        const newRecord: PoopRecord = {
          id: record.id,
          date: new Date(record.date),
          time: record.time,
          color: record.color,
          smell: record.smell,
          moisture: record.moisture,
          shape: record.shape,
          size: record.size,
          texture: record.texture,
          notes: record.notes,
          mood: record.mood
        };
        return newRecord;
      });
    } catch (error) {
      console.error('è·å–æœ¬åœ°è®°å½•å¤±è´¥:', error);
      return [];
    }
  }

  // ä¿å­˜æœ¬åœ°è®°å½•
  static saveLocalRecords(records: PoopRecord[]): boolean {
    try {
      const storageKey = RecordManager.getStorageKey();
      const recordsStr = JSON.stringify(records);
      AppStorage.setOrCreate(storageKey, recordsStr);
      return true;
    } catch (error) {
      console.error('ä¿å­˜æœ¬åœ°è®°å½•å¤±è´¥:', error);
      return false;
    }
  }

  // è·å–è®¿å®¢æ¨¡å¼è®°å½•ï¼ˆç”¨äºæ•°æ®åŒæ­¥ï¼‰
  static getGuestRecords(): PoopRecord[] {
    try {
      const recordsStr = AppStorage.get<string>(RecordManager.GUEST_STORAGE_KEY) || '[]';
      const records = JSON.parse(recordsStr) as PoopRecord[];
      return records.map(record => {
        const newRecord: PoopRecord = {
          id: record.id,
          userId: record.userId,
          date: new Date(record.date),
          time: record.time,
          color: record.color,
          smell: record.smell,
          moisture: record.moisture,
          shape: record.shape,
          size: record.size,
          texture: record.texture,
          notes: record.notes,
          mood: record.mood
        };
        return newRecord;
      });
    } catch (error) {
      console.error('è·å–è®¿å®¢è®°å½•å¤±è´¥:', error);
      return [];
    }
  }

  // æ¸…ç©ºè®¿å®¢æ¨¡å¼è®°å½•
  static clearGuestRecords(): boolean {
    try {
      AppStorage.setOrCreate(RecordManager.GUEST_STORAGE_KEY, '[]');
      return true;
    } catch (error) {
      console.error('æ¸…ç©ºè®¿å®¢è®°å½•å¤±è´¥:', error);
      return false;
    }
  }

  // è·å–æ‰€æœ‰è®°å½•ï¼ˆæ”¯æŒAPIå’Œæœ¬åœ°æ¨¡å¼ï¼‰
  static async getAllRecords(): Promise<PoopRecord[]> {
    if (RecordManager.isApiMode()) {
      try {
        const result = await ApiService.getAllRecords(1, 100); // è·å–å‰100æ¡è®°å½•
        return result.records;
      } catch (error) {
        console.error('APIè·å–è®°å½•å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼:', error);
        return RecordManager.getLocalRecords();
      }
    } else {
      return RecordManager.getLocalRecords();
    }
  }

  // æ·»åŠ è®°å½•ï¼ˆæ”¯æŒAPIå’Œæœ¬åœ°æ¨¡å¼ï¼‰
  static async addRecord(record: PoopRecord): Promise<boolean> {
    // åœ¨äº‘ç«¯æ¨¡å¼ä¸‹æ·»åŠ ç”¨æˆ·ID
    if (UserManager.isCloudMode() && UserManager.getCurrentUser()) {
      record.userId = UserManager.getCurrentUser()!.id;
    }
    
    if (RecordManager.isApiMode()) {
      try {
        await ApiService.createRecord(record);
        // APIæ·»åŠ æˆåŠŸåï¼Œä¹Ÿæ·»åŠ åˆ°æœ¬åœ°
        const localRecords = RecordManager.getLocalRecords();
        localRecords.unshift(record);
        RecordManager.saveLocalRecords(localRecords);
        return true;
      } catch (error) {
        console.error('APIæ·»åŠ è®°å½•å¤±è´¥:', error);
        return false;
      }
    } else {
      const records = RecordManager.getLocalRecords();
      records.unshift(record);
      return RecordManager.saveLocalRecords(records);
    }
  }

  // ä¿å­˜è®°å½•ï¼ˆæ”¯æŒAPIå’Œæœ¬åœ°æ¨¡å¼ï¼‰
  static async saveRecord(record: PoopRecord): Promise<boolean> {
    if (RecordManager.isApiMode()) {
      try {
        await ApiService.createRecord(record);
        // APIä¿å­˜æˆåŠŸåï¼Œä¹Ÿä¿å­˜åˆ°æœ¬åœ°ä½œä¸ºå¤‡ä»½
        const localRecords = RecordManager.getLocalRecords();
        localRecords.unshift(record);
        RecordManager.saveLocalRecords(localRecords);
        return true;
      } catch (error) {
        console.error('APIä¿å­˜è®°å½•å¤±è´¥ï¼Œä¿å­˜åˆ°æœ¬åœ°:', error);
        // APIå¤±è´¥æ—¶ä¿å­˜åˆ°æœ¬åœ°
        const localRecords = RecordManager.getLocalRecords();
        localRecords.unshift(record);
        return RecordManager.saveLocalRecords(localRecords);
      }
    } else {
      const records = RecordManager.getLocalRecords();
      records.unshift(record);
      return RecordManager.saveLocalRecords(records);
    }
  }

  // åˆ é™¤è®°å½•ï¼ˆæ”¯æŒAPIå’Œæœ¬åœ°æ¨¡å¼ï¼‰
  static async deleteRecord(id: number): Promise<boolean> {
    if (RecordManager.isApiMode()) {
      try {
        await ApiService.deleteRecord(id);
        // APIåˆ é™¤æˆåŠŸåï¼Œä¹Ÿä»æœ¬åœ°åˆ é™¤
        const localRecords = RecordManager.getLocalRecords();
        const filteredRecords = localRecords.filter(record => record.id !== id);
        RecordManager.saveLocalRecords(filteredRecords);
        return true;
      } catch (error) {
        console.error('APIåˆ é™¤è®°å½•å¤±è´¥:', error);
        return false;
      }
    } else {
      const records = RecordManager.getLocalRecords();
      const filteredRecords = records.filter(record => record.id !== id);
      return RecordManager.saveLocalRecords(filteredRecords);
    }
  }

  // æ›´æ–°è®°å½•ï¼ˆæ”¯æŒAPIå’Œæœ¬åœ°æ¨¡å¼ï¼‰
  static async updateRecord(id: number, record: PoopRecord): Promise<boolean> {
    if (RecordManager.isApiMode()) {
      try {
        await ApiService.updateRecord(id, record);
        // APIæ›´æ–°æˆåŠŸåï¼Œä¹Ÿæ›´æ–°æœ¬åœ°è®°å½•
        const localRecords = RecordManager.getLocalRecords();
        const index = localRecords.findIndex(r => r.id === id);
        if (index !== -1) {
          localRecords[index] = record;
          RecordManager.saveLocalRecords(localRecords);
        }
        return true;
      } catch (error) {
        console.error('APIæ›´æ–°è®°å½•å¤±è´¥:', error);
        return false;
      }
    } else {
      const records = RecordManager.getLocalRecords();
      const index = records.findIndex(r => r.id === id);
      if (index !== -1) {
        records[index] = record;
        return RecordManager.saveLocalRecords(records);
      }
      return false;
    }
  }

  // åŒæ­¥æœ¬åœ°æ•°æ®åˆ°æœåŠ¡å™¨
  static async syncToServer(): Promise<boolean> {
    try {
      const localRecords = RecordManager.getLocalRecords();
      let successCount = 0;

      for (const record of localRecords) {
        try {
          // åœ¨äº‘ç«¯æ¨¡å¼ä¸‹ä¸ºè®°å½•æ·»åŠ ç”¨æˆ·ID
          if (UserManager.isCloudMode() && UserManager.getCurrentUser()) {
            record.userId = UserManager.getCurrentUser()!.id;
          }
          await ApiService.createRecord(record);
          successCount++;
        } catch (error) {
          console.error(`åŒæ­¥è®°å½•å¤±è´¥ ${record.id}:`, error);
        }
      }

      console.log(`åŒæ­¥å®Œæˆ: ${successCount}/${localRecords.length} æ¡è®°å½•`);
      return successCount > 0;
    } catch (error) {
      console.error('åŒæ­¥åˆ°æœåŠ¡å™¨å¤±è´¥:', error);
      return false;
    }
  }

  // åŒæ­¥è®¿å®¢æ•°æ®åˆ°äº‘ç«¯
  static async syncGuestDataToCloud(): Promise<boolean> {
    try {
      if (!UserManager.isCloudMode() || !UserManager.getCurrentUser()) {
        throw new Error('Must be in cloud mode with logged in user');
      }

      const guestRecords = RecordManager.getGuestRecords();
      if (guestRecords.length === 0) {
        Logger.info('RECORD', 'No guest data to sync');
        return true;
      }

      let successCount = 0;
      const currentUser = UserManager.getCurrentUser()!;

      for (const record of guestRecords) {
        try {
          // ä¸ºè®¿å®¢è®°å½•æ·»åŠ ç”¨æˆ·ID
          const cloudRecord: PoopRecord = {
            id: record.id,
            userId: currentUser.id,
            date: record.date,
            time: record.time,
            color: record.color,
            smell: record.smell,
            moisture: record.moisture,
            shape: record.shape,
            size: record.size,
            texture: record.texture,
            notes: record.notes,
            mood: record.mood
          };
          
          if (RecordManager.isApiMode()) {
            await ApiService.createRecord(cloudRecord);
          }
          
          // æ·»åŠ åˆ°äº‘ç«¯æœ¬åœ°å­˜å‚¨
          const cloudRecords = RecordManager.getLocalRecords();
          cloudRecords.unshift(cloudRecord);
          RecordManager.saveLocalRecords(cloudRecords);
          
          successCount++;
        } catch (error) {
          Logger.error('SYNC', `Failed to sync guest record ${record.id}:`, error);
        }
      }

      Logger.info('RECORD', `Guest data sync completed: ${successCount}/${guestRecords.length} records`);
      
      if (successCount > 0) {
        // æ ‡è®°è®¿å®¢æ•°æ®å·²åŒæ­¥
        await UserManager.markGuestDataSynced();
      }
      
      return successCount > 0;
    } catch (error) {
      Logger.error('SYNC', 'Failed to sync guest data to cloud:', error);
      return false;
    }
  }

  // ä»æœåŠ¡å™¨åŒæ­¥æ•°æ®åˆ°æœ¬åœ°
  static async syncFromServer(): Promise<boolean> {
    try {
      const result = await ApiService.getAllRecords(1, 1000); // è·å–æ‰€æœ‰è®°å½•
      RecordManager.saveLocalRecords(result.records);
      console.log(`ä»æœåŠ¡å™¨åŒæ­¥äº† ${result.records.length} æ¡è®°å½•`);
      return true;
    } catch (error) {
      console.error('ä»æœåŠ¡å™¨åŒæ­¥å¤±è´¥:', error);
      return false;
    }
  }

  // ç”Ÿæˆå”¯ä¸€ID
  static generateId(): string {
    return Date.now().toString() + Math.random().toString(36).substr(2, 9);
  }

  // æ ¼å¼åŒ–æ—¥æœŸ
  static formatDate(date: Date): string {
    return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate())
      .padStart(2, '0')}`;
  }

  // æ ¼å¼åŒ–æ—¶é—´
  static formatTime(date: Date): string {
    return `${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;
  }

  // æ£€æŸ¥ç½‘ç»œè¿æ¥çŠ¶æ€
  static async checkApiConnection(): Promise<boolean> {
    Logger.network('RECORD', 'å¼€å§‹æ£€æŸ¥APIè¿æ¥...');
    try {
      await ApiService.getAllRecords();
      Logger.network('RECORD', 'APIè¿æ¥æ£€æŸ¥æˆåŠŸ');
      return true;
    } catch (error) {
      Logger.error('RECORD', 'APIè¿æ¥æ£€æŸ¥å¤±è´¥:', String(error));
      Logger.error('RECORD', 'è¯·æ£€æŸ¥: 1.ç½‘ç»œè¿æ¥ 2.æœåŠ¡å™¨çŠ¶æ€ 3.IPåœ°å€é…ç½®');
      return false;
    }
  }
}