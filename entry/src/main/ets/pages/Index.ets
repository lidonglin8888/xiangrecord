import { RecordManager, PoopRecord } from '../model/RecordModel';
import { Logger } from '../utils/Logger';
import { NetworkDiagnostic } from '../utils/NetworkDiagnostic';
import { RecordItem } from '../components/RecordItem';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';

@Entry
@Component
struct Index {
  @State records: PoopRecord[] = [];
  @State showWelcome: boolean = true;
  @State isLoading: boolean = false;
  @State isApiMode: boolean = false;
  @State connectionStatus: string = 'æ£€æŸ¥ä¸­...';

  aboutToAppear() {
    this.checkApiMode();
    this.loadRecords();
    // 3ç§’åŽéšè—æ¬¢è¿ŽåŠ¨ç”»
    setTimeout(() => {
      this.showWelcome = false;
    }, 3000);
  }

  checkApiMode() {
    this.isApiMode = RecordManager.isApiMode();
    this.checkConnection();
  }

  async checkConnection() {
    if (this.isApiMode) {
      Logger.ui('å¼€å§‹æ£€æŸ¥APIè¿žæŽ¥...');
      try {
        const isConnected = await RecordManager.checkApiConnection();
        this.connectionStatus = isConnected ? 'å·²è¿žæŽ¥' : 'è¿žæŽ¥å¤±è´¥';
        Logger.ui(`è¿žæŽ¥çŠ¶æ€: ${this.connectionStatus}`);
        
        if (!isConnected) {
          Logger.error('UI', 'APIè¿žæŽ¥å¤±è´¥ï¼Œå¼€å§‹ç½‘ç»œè¯Šæ–­...');
          
          // æ‰§è¡Œç½‘ç»œè¯Šæ–­
          const diagnosticResults = await NetworkDiagnostic.runFullDiagnostic();
          const report = NetworkDiagnostic.generateReport(diagnosticResults);
          Logger.error('UI', 'ç½‘ç»œè¯Šæ–­æŠ¥å‘Š:');
          Logger.error('UI', report);
          
          // è¾“å‡ºç®€åŒ–çš„é”™è¯¯ä¿¡æ¯åˆ°æŽ§åˆ¶å°
          Logger.error('UI', 'è¿žæŽ¥å¤±è´¥åŽŸå› åˆ†æž:');
          diagnosticResults.forEach((result, index) => {
            if (!result.success) {
              Logger.error('UI', `${index + 1}. ${result.message}`);
              if (result.suggestions) {
                result.suggestions.forEach(suggestion => {
                  Logger.error('UI', `   å»ºè®®: ${suggestion}`);
                });
              }
            }
          });
        }
      } catch (error) {
        Logger.error('UI', 'æ£€æŸ¥è¿žæŽ¥æ—¶å‘ç”Ÿé”™è¯¯:', error);
        this.connectionStatus = 'æ£€æŸ¥å¤±è´¥';
      }
    } else {
      this.connectionStatus = 'æœ¬åœ°æ¨¡å¼';
      Logger.ui('å½“å‰ä¸ºæœ¬åœ°æ¨¡å¼');
    }
  }

  toggleApiMode() {
    this.isApiMode = !this.isApiMode;
    RecordManager.setApiMode(this.isApiMode);
    
    if (this.isApiMode) {
      this.checkConnection();
      this.syncData();
    }
    
    this.loadRecords();
  }

  async syncData() {
    if (!this.isApiMode) return;
    
    try {
      // åŒæ­¥æœ¬åœ°æ•°æ®åˆ°æœåŠ¡å™¨
      await RecordManager.syncToServer();
      // ä»ŽæœåŠ¡å™¨åŒæ­¥æ•°æ®åˆ°æœ¬åœ°
      await RecordManager.syncFromServer();
      this.loadRecords();
    } catch (error) {
      console.error('åŒæ­¥å¤±è´¥:', error);
    }
  }

  async loadRecords() {
    this.isLoading = true;
    try {
      this.records = await RecordManager.getAllRecords();
    } catch (error) {
      console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
      promptAction.showToast({
        message: 'åŠ è½½è®°å½•å¤±è´¥',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Column() {
      if (this.showWelcome) {
        this.WelcomeAnimation()
      } else {
        this.MainContent()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFF8E7')
  }

  @Builder
  WelcomeAnimation() {
    Column() {
      Text('ðŸ’©')
        .fontSize(80)
        .animation({
          duration: 1000,
          curve: Curve.EaseInOut,
          iterations: -1,
          playMode: PlayMode.Alternate
        })
        .scale({ x: 1.2, y: 1.2 })
      
      Text('ä¾¿ä¾¿è®°å½•å°åŠ©æ‰‹')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#8B4513')
        .margin({ top: 20 })
      
      Text('è®°å½•æ¯ä¸€æ¬¡çš„å°ç¡®å¹¸~')
        .fontSize(16)
        .fontColor('#CD853F')
        .margin({ top: 10 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  MainContent() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
      this.HeaderSection()
      
      // å¿«æ·æ“ä½œåŒºåŸŸ
      this.QuickActionSection()
      
      // æœ€è¿‘è®°å½•åŒºåŸŸ
      this.RecentRecordsSection()
    }
    .width('100%')
    .height('100%')
    .padding({ left: 16, right: 16, top: 20 })
  }

  @Builder
  HeaderSection() {
    Column() {
      Row() {
        Column() {
          Text('ä¾¿ä¾¿æ—¥è®°')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#8B4513')
          
          Text('ä»Šå¤©çš„ä½ è¿˜å¥½å—ï¼Ÿ')
            .fontSize(14)
            .fontColor('#CD853F')
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        
        Blank()
        
        Text('ðŸ’©')
          .fontSize(40)
          .animation({
            duration: 2000,
            curve: Curve.EaseInOut,
            iterations: -1,
            playMode: PlayMode.Alternate
          })
          .rotate({ angle: 10 })
      }
      .width('100%')
      .margin({ bottom: 20 })
      
      // APIæ¨¡å¼åˆ‡æ¢
      Row() {
        Text('äº‘ç«¯åŒæ­¥')
          .fontSize(14)
          .fontColor('#8B4513')
        
        Blank()
        
        Toggle({ type: ToggleType.Switch, isOn: this.isApiMode })
          .selectedColor('#FF9500')
          .switchPointColor('#FFFFFF')
          .onChange((isOn: boolean) => {
            this.toggleApiMode();
          })
        
        Text(this.connectionStatus)
          .fontSize(12)
          .fontColor(this.connectionStatus === 'å·²è¿žæŽ¥' ? '#32CD32' : '#FF4444')
          .margin({ left: 8 })
      }
      .width('100%')
      .padding({ horizontal: 16, vertical: 12 })
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .margin({ bottom: 20 })
    }
  }

  @Builder
  QuickActionSection() {
    Column() {
      Text('å¿«æ·æ“ä½œ')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#8B4513')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 12 })
      
      Row() {
        // æ–°å¢žè®°å½•æŒ‰é’®
        Button() {
          Column() {
            Text('ðŸ“')
              .fontSize(32)
            Text('æ–°å¢žè®°å½•')
              .fontSize(14)
              .fontColor('#8B4513')
              .margin({ top: 8 })
          }
        }
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .width('48%')
        .height(100)
        .onClick(() => {
          router.pushUrl({ url: 'pages/AddRecord' });
        })
        
        Blank()
        
        // åŽ†å²è®°å½•æŒ‰é’®
        Button() {
          Column() {
            Text('ðŸ“Š')
              .fontSize(32)
            Text('åŽ†å²è®°å½•')
              .fontSize(14)
              .fontColor('#8B4513')
              .margin({ top: 8 })
          }
        }
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .width('48%')
        .height(100)
        .onClick(() => {
          router.pushUrl({ url: 'pages/HistoryList' });
        })
      }
      .width('100%')
    }
    .margin({ bottom: 24 })
  }

  @Builder
  RecentRecordsSection() {
    Column() {
      Row() {
        Text('æœ€è¿‘è®°å½•')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#8B4513')
        
        Blank()
        
        Text('æŸ¥çœ‹å…¨éƒ¨')
          .fontSize(14)
          .fontColor('#FF9500')
          .onClick(() => {
            router.pushUrl({ url: 'pages/HistoryList' });
          })
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      if (this.isLoading) {
        LoadingProgress()
          .color('#FF9500')
          .width(40)
          .height(40)
          .margin({ top: 20 })
      } else if (this.records.length === 0) {
        Column() {
          Text('ðŸŒŸ')
            .fontSize(48)
          Text('è¿˜æ²¡æœ‰è®°å½•å“¦')
            .fontSize(16)
            .fontColor('#CD853F')
            .margin({ top: 12 })
          Text('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è®°å½•å§~')
            .fontSize(14)
            .fontColor('#DEB887')
            .margin({ top: 8 })
        }
        .width('100%')
        .padding({ vertical: 40 })
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      } else {
        List() {
          ForEach(this.records.slice(0, 3), (record: PoopRecord) => {
            ListItem() {
              RecordItem({ record: record })
                .onClick(() => {
                  router.pushUrl({
                    url: 'pages/RecordDetail',
                    params: { recordId: record.id }
                  });
                })
            }
          })
        }
        .width('100%')
        .divider({ strokeWidth: 1, color: '#F0F0F0' })
      }
    }
    .layoutWeight(1)
  }
}