import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { UserManager, AppMode } from '../model/UserModel';
import { RecordManager } from '../model/RecordModel';
import { AuthService } from '../service/AuthService';
import { Logger } from '../utils/Logger';

@Entry
@Component
struct ModeSwitchPage {
  @State currentMode: AppMode = AppMode.GUEST;
  @State isLoading: boolean = false;
  @State guestRecordCount: number = 0;
  @State hasGuestData: boolean = false;
  @State isGuestDataSynced: boolean = false;

  aboutToAppear() {
    this.loadCurrentState();
  }

  async loadCurrentState() {
    this.currentMode = UserManager.getCurrentMode();
    
    // æ£€æŸ¥è®¿å®¢æ•°æ®
    const guestRecords = RecordManager.getGuestRecords();
    this.guestRecordCount = guestRecords.length;
    this.hasGuestData = this.guestRecordCount > 0;
    
    // æ£€æŸ¥è®¿å®¢æ•°æ®æ˜¯å¦å·²åŒæ­¥
    this.isGuestDataSynced = await UserManager.isGuestDataSynced();
  }

  // åˆ‡æ¢åˆ°äº‘ç«¯æ¨¡å¼
  async switchToCloudMode() {
    try {
      // è·³è½¬åˆ°ç™»å½•é¡µé¢
      router.pushUrl({
        url: 'pages/LoginPage'
      });
    } catch (error) {
      Logger.error('MODE_SWITCH', 'Failed to navigate to login page:', error);
      promptAction.showToast({
        message: 'è·³è½¬å¤±è´¥',
        duration: 2000
      });
    }
  }

  // ç»§ç»­ä½¿ç”¨è®¿å®¢æ¨¡å¼
  continueGuestMode() {
    router.back();
  }

  // åŒæ­¥è®¿å®¢æ•°æ®åˆ°äº‘ç«¯
  async syncGuestDataToCloud() {
    if (!UserManager.isLoggedIn()) {
      promptAction.showToast({
        message: 'è¯·å…ˆç™»å½•',
        duration: 2000
      });
      return;
    }

    this.isLoading = true;
    try {
      const success = await RecordManager.syncGuestDataToCloud();
      if (success) {
        this.isGuestDataSynced = true;
        promptAction.showToast({
          message: `æˆåŠŸåŒæ­¥ ${this.guestRecordCount} æ¡è®°å½•åˆ°äº‘ç«¯`,
          duration: 3000
        });
      } else {
        promptAction.showToast({
          message: 'åŒæ­¥å¤±è´¥ï¼Œè¯·ç¨åŽé‡è¯•',
          duration: 2000
        });
      }
    } catch (error) {
      Logger.error('MODE_SWITCH', 'Failed to sync guest data:', error);
      promptAction.showToast({
        message: 'åŒæ­¥å¤±è´¥ï¼š' + error.message,
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  // æ¸…ç©ºè®¿å®¢æ•°æ®
  showClearGuestDataDialog() {
    AlertDialog.show({
      title: 'æ¸…ç©ºè®¿å®¢æ•°æ®',
      message: `ç¡®å®šè¦æ¸…ç©º ${this.guestRecordCount} æ¡è®¿å®¢è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚`,
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      },
      secondaryButton: {
        value: 'ç¡®å®šæ¸…ç©º',
        fontColor: '#FF4444',
        action: () => {
          this.clearGuestData();
        }
      }
    });
  }

  async clearGuestData() {
    try {
      const success = RecordManager.clearGuestRecords();
      if (success) {
        this.guestRecordCount = 0;
        this.hasGuestData = false;
        await UserManager.resetGuestDataSyncStatus();
        this.isGuestDataSynced = false;
        
        promptAction.showToast({
          message: 'è®¿å®¢æ•°æ®å·²æ¸…ç©º',
          duration: 2000
        });
      } else {
        promptAction.showToast({
          message: 'æ¸…ç©ºå¤±è´¥',
          duration: 2000
        });
      }
    } catch (error) {
      Logger.error('MODE_SWITCH', 'Failed to clear guest data:', error);
      promptAction.showToast({
        message: 'æ¸…ç©ºå¤±è´¥ï¼š' + error.message,
        duration: 2000
      });
    }
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      Row() {
        Button('è¿”å›ž')
          .fontSize(16)
          .fontColor('#666666')
          .backgroundColor(Color.Transparent)
          .onClick(() => this.continueGuestMode())
        Text('æ¨¡å¼é€‰æ‹©')
          .fontSize(18)
          .fontWeight(FontWeight.Bold)
          .fontColor('#333333')
        Text('')
          .width(60)
      }
      .width('100%')
      .height(56)
      .padding({ left: 16, right: 16 })
      .backgroundColor('#FFFFFF')

      Scroll() {
        Column() {
          // å½“å‰æ¨¡å¼æ˜¾ç¤º
          Column() {
            Text('å½“å‰æ¨¡å¼')
              .fontSize(16)
              .fontColor('#666666')
              .margin({ bottom: 8 })
            
            Text(this.currentMode === AppMode.GUEST ? 'è®¿å®¢æ¨¡å¼' : 'äº‘ç«¯æ¨¡å¼')
              .fontSize(20)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.currentMode === AppMode.GUEST ? '#FF6B35' : '#8B4513')
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ bottom: 20 })

          // è®¿å®¢æ¨¡å¼å¡ç‰‡
          Column() {
            Row() {
              Column() {
                Text('ðŸ  è®¿å®¢æ¨¡å¼')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#FF6B35')
                  .margin({ bottom: 4 })
                
                Text('æ•°æ®ä»…ä¿å­˜åœ¨æœ¬åœ°è®¾å¤‡')
                  .fontSize(14)
                  .fontColor('#666666')
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              if (this.currentMode === AppMode.GUEST) {
                Text('å½“å‰æ¨¡å¼')
                  .fontSize(12)
                  .fontColor('#FFFFFF')
                  .backgroundColor('#FF6B35')
                  .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                  .borderRadius(10)
              }
            }
            .width('100%')
            .margin({ bottom: 16 })

            Text('â€¢ æ— éœ€æ³¨å†Œç™»å½•ï¼Œç«‹å³ä½¿ç”¨\nâ€¢ æ•°æ®ä¿å­˜åœ¨æœ¬åœ°ï¼Œéšç§å®‰å…¨\nâ€¢ ä¸æ”¯æŒå¤šè®¾å¤‡åŒæ­¥\nâ€¢ å¸è½½åº”ç”¨åŽæ•°æ®ä¸¢å¤±')
              .fontSize(14)
              .fontColor('#666666')
              .lineHeight(20)

            if (this.currentMode !== AppMode.GUEST) {
              Button('åˆ‡æ¢åˆ°è®¿å®¢æ¨¡å¼')
                .width('100%')
                .height(40)
                .fontSize(14)
                .fontColor('#FF6B35')
                .backgroundColor('#FFF5F0')
                .borderRadius(20)
                .border({ width: 1, color: '#FF6B35' })
                .margin({ top: 16 })
                .onClick(() => {
                  UserManager.switchToGuestMode();
                  this.currentMode = AppMode.GUEST;
                })
            }
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .border({
            width: this.currentMode === AppMode.GUEST ? 2 : 1,
            color: this.currentMode === AppMode.GUEST ? '#FF6B35' : '#E0E0E0'
          })
          .margin({ bottom: 16 })

          // äº‘ç«¯æ¨¡å¼å¡ç‰‡
          Column() {
            Row() {
              Column() {
                Text('â˜ï¸ äº‘ç«¯æ¨¡å¼')
                  .fontSize(18)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#8B4513')
                  .margin({ bottom: 4 })
                
                Text('æ•°æ®åŒæ­¥åˆ°äº‘ç«¯ï¼Œå¤šè®¾å¤‡å…±äº«')
                  .fontSize(14)
                  .fontColor('#666666')
              }
              .alignItems(HorizontalAlign.Start)
              .layoutWeight(1)
              
              if (this.currentMode === AppMode.CLOUD) {
                Text('å½“å‰æ¨¡å¼')
                  .fontSize(12)
                  .fontColor('#FFFFFF')
                  .backgroundColor('#8B4513')
                  .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                  .borderRadius(10)
              }
            }
            .width('100%')
            .margin({ bottom: 16 })

            Text('â€¢ æ”¯æŒå¤šç§ç™»å½•æ–¹å¼\nâ€¢ æ•°æ®äº‘ç«¯å¤‡ä»½ï¼Œæ°¸ä¸ä¸¢å¤±\nâ€¢ å¤šè®¾å¤‡å®žæ—¶åŒæ­¥\nâ€¢ æ›´å¤šé«˜çº§åŠŸèƒ½')
              .fontSize(14)
              .fontColor('#666666')
              .lineHeight(20)

            if (this.currentMode !== AppMode.CLOUD) {
              Button('åˆ‡æ¢åˆ°äº‘ç«¯æ¨¡å¼')
                .width('100%')
                .height(40)
                .fontSize(14)
                .fontColor('#FFFFFF')
                .backgroundColor('#8B4513')
                .borderRadius(20)
                .margin({ top: 16 })
                .onClick(() => this.switchToCloudMode())
            }
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .border({
            width: this.currentMode === AppMode.CLOUD ? 2 : 1,
            color: this.currentMode === AppMode.CLOUD ? '#8B4513' : '#E0E0E0'
          })
          .margin({ bottom: 20 })

          // è®¿å®¢æ•°æ®ç®¡ç†
          if (this.hasGuestData) {
            Column() {
              Text('è®¿å®¢æ•°æ®ç®¡ç†')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor('#333333')
                .margin({ bottom: 16 })
              
              Row() {
                Text('ðŸ“Š')
                  .fontSize(20)
                  .margin({ right: 12 })
                
                Column() {
                  Text(`${this.guestRecordCount} æ¡è®°å½•`)
                    .fontSize(16)
                    .fontColor('#333333')
                    .alignSelf(ItemAlign.Start)
                  
                  Text(this.isGuestDataSynced ? 'å·²åŒæ­¥åˆ°äº‘ç«¯' : 'å°šæœªåŒæ­¥')
                    .fontSize(12)
                    .fontColor(this.isGuestDataSynced ? '#4CAF50' : '#FF9800')
                    .alignSelf(ItemAlign.Start)
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)
              }
              .width('100%')
              .margin({ bottom: 16 })

              if (UserManager.isLoggedIn() && !this.isGuestDataSynced) {
                Button(this.isLoading ? 'åŒæ­¥ä¸­...' : 'åŒæ­¥åˆ°äº‘ç«¯')
                  .width('100%')
                  .height(40)
                  .fontSize(14)
                  .fontColor('#FFFFFF')
                  .backgroundColor('#4CAF50')
                  .borderRadius(20)
                  .enabled(!this.isLoading)
                  .margin({ bottom: 8 })
                  .onClick(() => this.syncGuestDataToCloud())
              }

              Button('æ¸…ç©ºè®¿å®¢æ•°æ®')
                .width('100%')
                .height(40)
                .fontSize(14)
                .fontColor('#FF4444')
                .backgroundColor('#FFEBEE')
                .borderRadius(20)
                .border({ width: 1, color: '#FF4444' })
                .onClick(() => this.showClearGuestDataDialog())
            }
            .width('100%')
            .padding(20)
            .backgroundColor('#FFFFFF')
            .borderRadius(12)
            .margin({ bottom: 20 })
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 20, bottom: 20 })
      }
      .layoutWeight(1)
      .backgroundColor('#F8F8F8')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F8F8F8')
  }
}