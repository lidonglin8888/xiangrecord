import { RecordManager, PoopRecord, COLOR_OPTIONS, SMELL_OPTIONS, MOISTURE_OPTIONS, SHAPE_OPTIONS, SIZE_OPTIONS, TEXTURE_OPTIONS, MOOD_OPTIONS } from '../model/RecordModel';
import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { TopNavigation } from '../components/TopNavigation';

interface InfoItem {
  label: string;
  value: string;
  icon: string;
}

interface RouterParams {
  record: PoopRecord;
}

@Entry
@Component
struct RecordDetail {
  @State record: PoopRecord | null = null;

  aboutToAppear() {
    const params = router.getParams() as RouterParams;
    if (params && params.record) {
      this.record = params.record;
    }
  }

  build() {
    Column() {
      if (this.record) {
        this.RecordContent()
      } else {
        this.ErrorContent()
      }
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFF8E7')
  }

  @Builder
  RecordContent() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      TopNavigation({ title: 'è®°å½•è¯¦æƒ…' })
      
      // è®°å½•å¡ç‰‡
      this.RecordCard()
      
      // è¯¦ç»†ä¿¡æ¯
      this.DetailSections()
      
      // åº•éƒ¨æ“ä½œ
      this.BottomActions()
    }
    .width('100%')
    .height('100%')
  }



  @Builder
  RecordCard() {
    Column() {
      // æ—¥æœŸæ—¶é—´
      Text(RecordManager.formatDate(new Date(this.record!.date)))
        .fontSize(16)
        .fontColor('#8B4513')
        .margin({ bottom: 4 })
      
      Text(this.record!.time)
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FF9500')
        .margin({ bottom: 16 })
      
      // å¿ƒæƒ…å¤§å›¾æ ‡
      Text(this.getMoodEmoji(this.record!.mood))
        .fontSize(80)
        .margin({ bottom: 16 })
      
      Text(this.getMoodLabel(this.record!.mood))
        .fontSize(18)
        .fontColor('#8B4513')
    }
    .width('100%')
    .padding(24)
    .backgroundColor('#FFFFFF')
    .borderRadius(20)
    .margin({ left: 16, right: 16, bottom: 20 })
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  DetailSections() {
    Scroll() {
      Column() {
        // åŸºæœ¬ä¿¡æ¯
        this.InfoSection('åŸºæœ¬ç‰¹å¾', [
          { label: 'é¢œè‰²', value: this.getColorInfo(), icon: 'ğŸ¨' },
          { label: 'å½¢çŠ¶', value: this.getShapeInfo(), icon: 'ğŸ”„' },
          { label: 'å¤§å°', value: this.getSizeInfo(), icon: 'ğŸ“' }
        ] as InfoItem[])
        
        // è´¨åœ°ä¿¡æ¯
        this.InfoSection('è´¨åœ°ç‰¹å¾', [
          { label: 'å¹²æ¹¿åº¦', value: this.getMoistureInfo(), icon: 'ğŸ’§' },
          { label: 'è´¨åœ°', value: this.getTextureInfo(), icon: 'âœ‹' },
          { label: 'æ°”å‘³', value: this.getSmellInfo(), icon: 'ğŸ‘ƒ' }
        ] as InfoItem[])
        
        // å¤‡æ³¨ä¿¡æ¯
        if (this.record!.notes && this.record!.notes.trim() !== '') {
          this.NotesSection()
        }
      }
    }
    .layoutWeight(1)
    .padding({ left: 16, right: 16 })
  }

  @Builder
  InfoSection(title: string, items: InfoItem[]) {
    Column() {
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#8B4513')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 12 })
      
      ForEach(items, (item: InfoItem) => {
        Row() {
          Text(item.icon)
            .fontSize(20)
            .width(30)
          
          Text(item.label)
            .fontSize(14)
            .fontColor('#8B4513')
            .width(60)
          
          Text(item.value)
            .fontSize(14)
            .fontColor('#CD853F')
            .layoutWeight(1)
        }
        .width('100%')
        .padding({ top: 8, bottom: 8 })
      })
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .margin({ bottom: 12 })
  }

  @Builder
  NotesSection() {
    Column() {
      Text('å¤‡æ³¨')
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#8B4513')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 12 })
      
      Text(this.record!.notes!)
        .fontSize(14)
        .fontColor('#CD853F')
        .lineHeight(20)
        .width('100%')
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#FFFFFF')
    .borderRadius(12)
    .margin({ bottom: 12 })
    .alignItems(HorizontalAlign.Start)
  }

  @Builder
  BottomActions() {
    Row() {
      Button('åˆ é™¤è®°å½•')
        .width(100)
        .height(44)
        .backgroundColor('#FF3B30')
        .fontColor('#FFFFFF')
        .borderRadius(22)
        .onClick(() => {
          this.showDeleteConfirm();
        })
      
      Blank()
      
      Button('åˆ†äº«è®°å½•')
        .width(100)
        .height(44)
        .backgroundColor('#34C759')
        .fontColor('#FFFFFF')
        .borderRadius(22)
        .onClick(() => {
          this.shareRecord();
        })
    }
    .width('100%')
    .padding({ left: 16, right: 16, bottom: 30 })
  }

  @Builder
  ErrorContent() {
    Column() {
      Text('ğŸ˜µ')
        .fontSize(80)
        .margin({ bottom: 20 })
      
      Text('è®°å½•ä¸å­˜åœ¨')
        .fontSize(18)
        .fontColor('#8B4513')
        .margin({ bottom: 8 })
      
      Text('è¯¥è®°å½•å¯èƒ½å·²è¢«åˆ é™¤')
        .fontSize(14)
        .fontColor('#CD853F')
        .margin({ bottom: 30 })
      
      Button('è¿”å›é¦–é¡µ')
        .backgroundColor('#FF9500')
        .fontColor('#FFFFFF')
        .borderRadius(20)
        .onClick(() => {
          router.clear();
          router.pushUrl({ url: 'pages/Index' });
        })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  // è·å–å„ç§ä¿¡æ¯çš„æ–¹æ³•
  getMoodEmoji(mood: string): string {
    const option = MOOD_OPTIONS.find(opt => opt.value === mood);
    return option ? option.emoji : 'ğŸ˜Š';
  }

  getMoodLabel(mood: string): string {
    const option = MOOD_OPTIONS.find(opt => opt.value === mood);
    return option ? option.label : mood;
  }

  getColorInfo(): string {
    const option = COLOR_OPTIONS.find(opt => opt.value === this.record!.color);
    return option ? option.label : this.record!.color;
  }

  getShapeInfo(): string {
    const option = SHAPE_OPTIONS.find(opt => opt.value === this.record!.shape);
    return option ? option.label : this.record!.shape;
  }

  getSizeInfo(): string {
    const option = SIZE_OPTIONS.find(opt => opt.value === this.record!.size);
    return option ? option.label : this.record!.size;
  }

  getMoistureInfo(): string {
    const option = MOISTURE_OPTIONS.find(opt => opt.value === this.record!.moisture);
    return option ? option.label : this.record!.moisture;
  }

  getTextureInfo(): string {
    const option = TEXTURE_OPTIONS.find(opt => opt.value === this.record!.texture);
    return option ? option.label : this.record!.texture;
  }

  getSmellInfo(): string {
    const option = SMELL_OPTIONS.find(opt => opt.value === this.record!.smell);
    return option ? option.label : this.record!.smell;
  }

  showDeleteConfirm() {
    AlertDialog.show({
      title: 'ç¡®è®¤åˆ é™¤',
      message: 'ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚',
      primaryButton: {
        value: 'å–æ¶ˆ',
        action: () => {}
      },
      secondaryButton: {
        value: 'åˆ é™¤',
        fontColor: '#FF3B30',
        action: async () => {
          const success = await RecordManager.deleteRecord(this.record!.id);
          if (success) {
            promptAction.showToast({
              message: 'åˆ é™¤æˆåŠŸ',
              duration: 1500
            });
            router.back();
          } else {
            promptAction.showToast({
              message: 'åˆ é™¤å¤±è´¥',
              duration: 1500
            });
          }
        }
      }
    });
  }

  shareRecord() {
    const shareText = `æˆ‘çš„ä¾¿ä¾¿è®°å½• ğŸ“Š\n` +
      `æ—¶é—´: ${RecordManager.formatDate(new Date(this.record!.date))} ${this.record!.time}\n` +
      `å¿ƒæƒ…: ${this.getMoodLabel(this.record!.mood)}\n` +
      `ç‰¹å¾: ${this.getColorInfo()} Â· ${this.getShapeInfo()} Â· ${this.getSizeInfo()}\n` +
      `æ¥è‡ªä¾¿ä¾¿è®°å½•å°åŠ©æ‰‹ ğŸ’©`;
    
    promptAction.showToast({
      message: 'åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­...',
      duration: 2000
    });
  }
}