import { RecordManager, PoopRecord } from '../model/RecordModel';
import { UserManager, AppMode } from '../model/UserModel';
import { RecordItem } from '../components/RecordItem';
import { Logger } from '../utils/Logger';
import { NetworkDiagnostic } from '../utils/NetworkDiagnostic';
import router from '@ohos.router';
import prompt from '@ohos.prompt';
import { router as arkRouter } from '@kit.ArkUI';

// å®šä¹‰åŠŸèƒ½é¡¹æ¥å£
interface FunctionItem {
  icon: string;
  title: string;
  action: () => void | Promise<void>;
}

@Entry
@Component
struct MainTabs {
  @State currentTabIndex: number = 0;
  @State records: PoopRecord[] = [];
  @State showWelcome: boolean = true;
  @State isLoading: boolean = false;
  @State isApiMode: boolean = false;
  @State connectionStatus: string = 'æ£€æŸ¥ä¸­...';

  async aboutToAppear() {
    // åˆå§‹åŒ–ç”¨æˆ·ç®¡ç†å™¨ï¼Œè¯»å–ä¸Šæ¬¡çš„æ¨¡å¼
    await UserManager.initialize();
    
    // æ£€æŸ¥å½“å‰æ¨¡å¼å¹¶å¤„ç†ç›¸åº”é€»è¾‘
    await this.checkAppMode();
    
    this.checkApiMode();
    this.loadRecords();
    // 3ç§’åéšè—æ¬¢è¿åŠ¨ç”»
    setTimeout(() => {
      this.showWelcome = false;
    }, 3000);
  }

  // é¡µé¢é‡æ–°æ˜¾ç¤ºæ—¶æ£€æŸ¥æ¨¡å¼çŠ¶æ€
  async onPageShow() {
    Logger.info('UI', 'MainTabs page shown, checking app mode');
    // é‡æ–°æ£€æŸ¥åº”ç”¨æ¨¡å¼ï¼Œå¤„ç†ä»å…¶ä»–é¡µé¢è¿”å›çš„æƒ…å†µ
    await this.checkAppMode();
    this.checkApiMode();
    // é‡æ–°åŠ è½½è®°å½•ä»¥ç¡®ä¿æ•°æ®åŒæ­¥
    this.loadRecords();
  }

  // æ£€æŸ¥åº”ç”¨æ¨¡å¼å¹¶å¤„ç†ç›¸åº”é€»è¾‘
  async checkAppMode() {
    // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€ï¼Œæ ¹æ®ç™»å½•çŠ¶æ€è‡ªåŠ¨è®¾ç½®æ¨¡å¼
    if (UserManager.isLoggedIn()) {
      // ç”¨æˆ·å·²ç™»å½•ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°äº‘ç«¯æ¨¡å¼
      if (UserManager.getCurrentMode() !== AppMode.CLOUD) {
        await UserManager.switchToCloudMode();
        Logger.info('UI', 'ç”¨æˆ·å·²ç™»å½•ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°äº‘ç«¯æ¨¡å¼');
      }
      // è®¾ç½®ä¸ºAPIæ¨¡å¼
      RecordManager.setApiMode(true);
      this.isApiMode = true;
      Logger.ui('äº‘ç«¯æ¨¡å¼ä¸”ç”¨æˆ·å·²ç™»å½•ï¼Œè®¾ç½®ä¸ºAPIæ¨¡å¼');
    } else {
      // ç”¨æˆ·æœªç™»å½•ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼
      if (UserManager.getCurrentMode() !== AppMode.GUEST) {
        await UserManager.switchToGuestMode();
        Logger.info('UI', 'ç”¨æˆ·æœªç™»å½•ï¼Œè‡ªåŠ¨åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼');
      }
      // è®¾ç½®ä¸ºæœ¬åœ°æ¨¡å¼
      RecordManager.setApiMode(false);
      this.isApiMode = false;
      Logger.ui('è®¿å®¢æ¨¡å¼ï¼Œè®¾ç½®ä¸ºæœ¬åœ°æ¨¡å¼');
    }
    
    const currentMode = UserManager.getCurrentMode();
    Logger.info('UI', `å½“å‰åº”ç”¨æ¨¡å¼: ${currentMode}`);
  }

  checkApiMode() {
    this.isApiMode = RecordManager.isApiMode();
    this.checkConnection();
  }

  async checkConnection() {
    if (this.isApiMode) {
      // æ£€æŸ¥APIè¿æ¥çŠ¶æ€
      Logger.ui('å¼€å§‹æ£€æŸ¥APIè¿æ¥...');
      try {
        const isConnected = await RecordManager.checkApiConnection();
        this.connectionStatus = isConnected ? 'å·²è¿æ¥' : 'è¿æ¥å¤±è´¥';
        Logger.ui(`APIè¿æ¥çŠ¶æ€: ${this.connectionStatus}`);
      } catch (error) {
        this.connectionStatus = 'è¿æ¥å¤±è´¥';
        Logger.error('UI', 'APIè¿æ¥æ£€æŸ¥å¤±è´¥:', error);
      }
    } else {
      this.connectionStatus = 'æœ¬åœ°æ¨¡å¼';
    }
  }

  async toggleApiMode() {
    try {
      router.push({
        url: 'pages/ModeSwitchPage'
      });
    } catch (error) {
      Logger.error('UI', 'Failed to navigate to mode switch page:', error);
    }
  }

  async syncData() {
    if (!this.isApiMode) {
      prompt.showToast({
        message: 'å½“å‰ä¸ºæœ¬åœ°æ¨¡å¼ï¼Œæ— éœ€åŒæ­¥',
        duration: 2000
      });
      return;
    }

    prompt.showToast({
      message: 'å¼€å§‹åŒæ­¥æ•°æ®...',
      duration: 1000
    });

    try {
      // åŒæ­¥æœ¬åœ°æ•°æ®åˆ°æœåŠ¡å™¨
      await RecordManager.syncToServer();
      // ä»æœåŠ¡å™¨åŒæ­¥æ•°æ®åˆ°æœ¬åœ°
      await RecordManager.syncFromServer();
      this.loadRecords();
    } catch (error) {
      console.error('åŒæ­¥å¤±è´¥:', error);
    }
  }

  async loadRecords() {
    this.isLoading = true;
    try {
      this.records = await RecordManager.getAllRecords();
    } catch (error) {
      console.error('åŠ è½½è®°å½•å¤±è´¥:', error);
      prompt.showToast({
        message: 'åŠ è½½è®°å½•å¤±è´¥',
        duration: 2000
      });
    } finally {
      this.isLoading = false;
    }
  }

  build() {
    Column() {
      // ä¸»è¦å†…å®¹åŒºåŸŸ
      if (this.currentTabIndex === 0) {
        this.RecordTabContent()
      } else {
        this.ProfileTabContent()
      }
      
      // åº•éƒ¨Tabæ 
      this.BottomTabBar()
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFF8E7')
    .expandSafeArea([SafeAreaType.SYSTEM], [SafeAreaEdge.TOP, SafeAreaEdge.BOTTOM])
  }

  @Builder
  RecordTabContent() {
    Column() {
      if (this.showWelcome) {
        this.WelcomeAnimation()
      } else {
        this.MainContent()
      }
    }
    .width('100%')
    .layoutWeight(1)
  }

  @Builder
  ProfileTabContent() {
    Column() {
      // é¡¶éƒ¨ç”¨æˆ·ä¿¡æ¯åŒºåŸŸ
      this.UserInfoSection()
      
      // åŠŸèƒ½åˆ—è¡¨
      this.FunctionListSection()
    }
    .width('100%')
    .layoutWeight(1)
    .padding({ left: 16, right: 16, top: 20 })
  }

  @Builder
  UserInfoSection() {
    Column() {
      Row() {
        Text('æˆ‘çš„')
          .fontSize(28)
          .fontWeight(FontWeight.Bold)
          .fontColor('#8B4513')
        
        Blank()
        
        Text('âš™ï¸')
          .fontSize(24)
      }
      .width('100%')
      .margin({ bottom: 30 })
      
      // ç”¨æˆ·çŠ¶æ€å¡ç‰‡
      Row() {
        Column() {
          if (UserManager.isLoggedIn()) {
            Text('ğŸ‘¤')
              .fontSize(40)
              .margin({ bottom: 8 })
            Text('å·²ç™»å½•ç”¨æˆ·')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#8B4513')
            Text(this.isApiMode ? 'äº‘ç«¯æ¨¡å¼' : 'æœ¬åœ°æ¨¡å¼')
              .fontSize(12)
              .fontColor('#CD853F')
              .margin({ top: 4 })
          } else {
            Text('ğŸ‘¤')
              .fontSize(40)
              .margin({ bottom: 8 })
            Text('è®¿å®¢æ¨¡å¼')
              .fontSize(16)
              .fontWeight(FontWeight.Medium)
              .fontColor('#8B4513')
            Text('ç‚¹å‡»ç™»å½•äº«å—æ›´å¤šåŠŸèƒ½')
              .fontSize(12)
              .fontColor('#CD853F')
              .margin({ top: 4 })
          }
        }
        .alignItems(HorizontalAlign.Start)
        
        Blank()
        
        if (!UserManager.isLoggedIn()) {
          Button('ç™»å½•')
            .fontSize(14)
            .height(32)
            .backgroundColor('#FF9500')
            .onClick(() => {
              router.push({ url: 'pages/LoginPage' });
            })
        }
      }
      .width('100%')
      .padding(20)
      .backgroundColor('#FFFFFF')
      .borderRadius(16)
      .margin({ bottom: 30 })
    }
    .width('100%')
  }

  // è·å–è´¦æˆ·ç®¡ç†åŠŸèƒ½é¡¹
  private getAccountItems(): FunctionItem[] {
    return [
      { icon: 'ğŸ‘¤', title: 'ä¸ªäººä¿¡æ¯', action: (): void => this.navigateToPersonalInfo() },
      { icon: 'ğŸšª', title: 'é€€å‡ºç™»å½•', action: () => this.logout() },
      { icon: 'ğŸ—‘ï¸', title: 'æ³¨é”€è´¦å·', action: (): void => this.deleteAccount() }
    ];
  }

  // è·å–ç™»å½•åŠŸèƒ½é¡¹
  private getLoginItems(): FunctionItem[] {
    return [
      { icon: 'ğŸ”‘', title: 'æ³¨å†Œ', action: (): void => this.navigateToRegister() },
      { icon: 'ğŸšª', title: 'ç™»å½•', action: (): void => this.navigateToLogin() }
    ];
  }

  // è·å–åº”ç”¨ä¿¡æ¯åŠŸèƒ½é¡¹
  private getAppInfoItems(): FunctionItem[] {
    return [
      { icon: 'ğŸ“„', title: 'ç”¨æˆ·åè®®', action: (): void => this.showUserAgreement() },
      { icon: 'ğŸ”’', title: 'éšç§æ”¿ç­–', action: (): void => this.showPrivacyPolicy() },
      { icon: 'ğŸ“', title: 'æ›´æ–°æ—¥å¿—', action: (): void => this.showUpdateLog() },
      { icon: 'ğŸ’¡', title: 'æéœ€æ±‚', action: (): void => this.submitFeedback() }
    ];
  }

  @Builder
  FunctionListSection() {
    Column() {
      // è´¦æˆ·ç®¡ç†
      if (UserManager.isLoggedIn()) {
        this.FunctionGroup('è´¦æˆ·ç®¡ç†', this.getAccountItems())
      } else {
        this.FunctionGroup('è´¦æˆ·', this.getLoginItems())
      }
      
      // åº”ç”¨ä¿¡æ¯
      this.FunctionGroup('åº”ç”¨ä¿¡æ¯', this.getAppInfoItems())
    }
    .width('100%')
  }

  @Builder
  FunctionGroup(title: string, items: FunctionItem[]) {
    Column() {
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Medium)
        .fontColor('#8B4513')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 12 })
      
      Column() {
        ForEach(items, (item: FunctionItem, index: number) => {
          Row() {
            Text(item.icon)
              .fontSize(20)
              .margin({ right: 12 })
            
            Text(item.title)
              .fontSize(16)
              .fontColor('#8B4513')
              .layoutWeight(1)
            
            Text('â€º')
              .fontSize(20)
              .fontColor('#DEB887')
          }
          .width('100%')
          .height(50)
          .padding({ left: 16, right: 16 })
          .onClick(() => item.action())
          
          if (index < items.length - 1) {
            Divider()
              .color('#F0F0F0')
              .margin({ left: 48 })
          }
        })
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .margin({ bottom: 20 })
    }
    .width('100%')
  }

  @Builder
  BottomTabBar() {
    Row() {
      // è®°å½•Tab
      Column() {
        Text(this.currentTabIndex === 0 ? 'ğŸ“' : 'ğŸ“')
          .fontSize(24)
          .fontColor(this.currentTabIndex === 0 ? '#FF9500' : '#8B4513')
        Text('è®°å½•')
          .fontSize(12)
          .fontColor(this.currentTabIndex === 0 ? '#FF9500' : '#8B4513')
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .onClick(() => {
        this.currentTabIndex = 0;
      })
      
      // æˆ‘çš„Tab
      Column() {
        Text(this.currentTabIndex === 1 ? 'ğŸ‘¤' : 'ğŸ‘¤')
          .fontSize(24)
          .fontColor(this.currentTabIndex === 1 ? '#FF9500' : '#8B4513')
        Text('æˆ‘çš„')
          .fontSize(12)
          .fontColor(this.currentTabIndex === 1 ? '#FF9500' : '#8B4513')
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .onClick(() => {
        this.currentTabIndex = 1;
      })
    }
    .width('100%')
    .height(80)
    .backgroundColor('#FFFFFF')
    .border({ width: { top: 1 }, color: '#F0F0F0' })
    .padding({ top: 8, bottom: 8 })
  }

  @Builder
  WelcomeAnimation() {
    Column() {
      Text('ğŸ’©')
        .fontSize(80)
        .animation({
          duration: 1000,
          curve: Curve.EaseInOut,
          iterations: -1,
          playMode: PlayMode.Alternate
        })
        .scale({ x: 1.2, y: 1.2 })
      
      Text('ä¾¿ä¾¿è®°å½•å°åŠ©æ‰‹')
        .fontSize(24)
        .fontWeight(FontWeight.Bold)
        .fontColor('#8B4513')
        .margin({ top: 20 })
      
      Text('è®°å½•æ¯ä¸€æ¬¡çš„å°ç¡®å¹¸~')
        .fontSize(16)
        .fontColor('#CD853F')
        .margin({ top: 10 })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
  }

  @Builder
  MainContent() {
    Column() {
      // é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ
      this.HeaderSection()
      
      // å¿«æ·æ“ä½œåŒºåŸŸ
      this.QuickActionSection()
      
      // æœ€è¿‘è®°å½•åŒºåŸŸ
      this.RecentRecordsSection()
    }
    .width('100%')
    .height('100%')
    .padding({ left: 16, right: 16, top: 20 })
  }

  @Builder
  HeaderSection() {
    Column() {
      Row() {
        Column() {
          Text('ä¾¿ä¾¿æ—¥è®°')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#8B4513')
          
          Text('ä»Šå¤©çš„ä½ è¿˜å¥½å—ï¼Ÿ')
            .fontSize(14)
            .fontColor('#CD853F')
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        
        Blank()
        
        Text('ğŸ’©')
          .fontSize(40)
          .animation({
            duration: 2000,
            curve: Curve.EaseInOut,
            iterations: -1,
            playMode: PlayMode.Alternate
          })
          .rotate({ angle: 10 })
      }
      .width('100%')
      
      // APIæ¨¡å¼çŠ¶æ€æ 
      // Row() {
      //   Text(this.isApiMode ? 'ğŸŒ äº‘ç«¯æ¨¡å¼' : 'ğŸ“± æœ¬åœ°æ¨¡å¼')
      //     .fontSize(12)
      //     .fontColor(this.isApiMode ? '#007AFF' : '#8B4513')
      //
      //   Text('|')
      //     .fontSize(12)
      //     .fontColor('#DEB887')
      //     .margin({ left: 8, right: 8 })
      //
      //   Text(this.connectionStatus)
      //     .fontSize(12)
      //     .fontColor(this.connectionStatus === 'å·²è¿æ¥' ? '#34C759' :
      //               this.connectionStatus === 'è¿æ¥å¤±è´¥' ? '#FF3B30' : '#8B4513')
      //
      //   Blank()
      //
      //   Button('åˆ‡æ¢æ¨¡å¼')
      //     .fontSize(10)
      //     .height(24)
      //     .backgroundColor(this.isApiMode ? '#FF9500' : '#007AFF')
      //     .onClick(() => {
      //       this.toggleApiMode();
      //     })
      // }
      // .width('100%')
      // .margin({ top: 12 })
    }
    .width('100%')
    .margin({ bottom: 30 })
  }

  @Builder
  QuickActionSection() {
    Column() {
      Text('å¿«æ·æ“ä½œ')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#8B4513')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })
      
      Row() {
        // æ–°å¢è®°å½•æŒ‰é’®
        Button() {
          Column() {
            Text('ğŸ“')
              .fontSize(32)
            Text('æ–°å¢è®°å½•')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .margin({ top: 8 })
          }
        }
        .width(100)
        .height(100)
        .backgroundColor('#FF9500')
        .borderRadius(16)
        .onClick(() => {
          router.pushUrl({ url: 'pages/AddRecord' });
        })
        
        // æŸ¥çœ‹å†å²æŒ‰é’®
        Button() {
          Column() {
            Text('ğŸ“Š')
              .fontSize(32)
            Text('å†å²è®°å½•')
              .fontSize(14)
              .fontColor('#FFFFFF')
              .margin({ top: 8 })
          }
        }
        .width(100)
        .height(100)
        .backgroundColor('#34C759')
        .borderRadius(16)
        .onClick(() => {
          router.pushUrl({ url: 'pages/HistoryList' });
        })

        // åŒæ­¥æŒ‰é’®ï¼ˆä»…åœ¨APIæ¨¡å¼ä¸‹æ˜¾ç¤ºï¼‰
        if (this.isApiMode) {
          Button() {
            Column() {
              Text('åŒæ­¥æ•°æ®')
                .fontSize(14)
                .fontColor('#FFFFFF')
                .margin({ top: 8 })
            }
          }
          .width(100)
          .height(100)
          .backgroundColor('#007AFF')
          .borderRadius(16)
          .onClick(() => {
            this.syncData();
          })
        }
      }
      .width('100%')
      .justifyContent(FlexAlign.SpaceBetween)
    }
    .width('100%')
    .margin({ bottom: 30 })
  }

  @Builder
  RecentRecordsSection() {
    Column() {
      Row() {
        Text('æœ€è¿‘è®°å½•')
          .fontSize(18)
          .fontWeight(FontWeight.Medium)
          .fontColor('#8B4513')
        
        Blank()
        
        if (this.records.length > 5) {
          Text('æŸ¥çœ‹å…¨éƒ¨')
            .fontSize(16)
            .fontColor('#FF9500')
            .onClick(() => {
              router.pushUrl({ url: 'pages/HistoryList' });
            })
          Text(' â€º')
            .fontSize(20)
            .fontColor('#FF9500')
            .onClick(() => {
              router.pushUrl({ url: 'pages/HistoryList' });
            })
        }
      }
      .width('100%')
      .margin({ bottom: 16 })
      
      if (this.records.length === 0) {
        Column() {
          Text('ğŸŒŸ')
            .fontSize(48)
            .margin({ bottom: 16 })
          
          Text('è¿˜æ²¡æœ‰è®°å½•å“¦~')
            .fontSize(16)
            .fontColor('#CD853F')
          
          Text('ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®å¼€å§‹è®°å½•å§ï¼')
            .fontSize(14)
            .fontColor('#DEB887')
            .margin({ top: 8 })
        }
        .width('100%')
        .height(200)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .border({ width: 2, color: '#F0E68C', style: BorderStyle.Dashed })
      } else {
        Scroll() {
          Column() {
            ForEach(this.records.slice(0, 5), (record: PoopRecord) => {
              RecordItem({ 
                record: record, 
                asListItem: false, 
                showNotes: false, 
                showDeleteAction: false,
                showShareAction: false
              })
            })
          }
          .width('100%')
        }
        .width('100%')
        .height(300)
        .scrollable(ScrollDirection.Vertical)
        .scrollBar(BarState.Off)
      }
    }
    .width('100%')
  }

  // åŠŸèƒ½æ–¹æ³•
  navigateToPersonalInfo() {
    router.pushUrl({ url: 'pages/PersonalInfoPage' });
  }

  async logout(): Promise<void> {
    try {
      await UserManager.logout();
      prompt.showToast({
        message: 'å·²é€€å‡ºç™»å½•',
        duration: 2000
      });
      // åˆ·æ–°é¡µé¢çŠ¶æ€
      await this.checkAppMode();
    } catch (error) {
      Logger.error('UI', 'Logout failed:', error);
      prompt.showToast({
        message: 'é€€å‡ºç™»å½•å¤±è´¥',
        duration: 2000
      });
    }
  }

  deleteAccount() {
    prompt.showToast({
      message: 'æ³¨é”€è´¦å·åŠŸèƒ½å¼€å‘ä¸­...',
      duration: 2000
    });
  }

  navigateToRegister() {
    router.pushUrl({ url: 'pages/LoginPage' });
  }

  navigateToLogin() {
    router.pushUrl({ url: 'pages/LoginPage' });
  }

  showUserAgreement() {
    router.pushUrl({ url: 'pages/UserAgreementPage' });
  }

  showPrivacyPolicy() {
    router.pushUrl({ url: 'pages/PrivacyPolicyPage' });
  }

  showUpdateLog() {
    router.pushUrl({ url: 'pages/UpdateLogPage' });
  }

  submitFeedback() {
    router.pushUrl({ url: 'pages/FeedbackPage' });
  }

  showPersonalInfo() {
    router.pushUrl({ url: 'pages/PersonalInfoPage' });
  }
}