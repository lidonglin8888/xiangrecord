import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { UserManager } from '../model/UserModel';
import { Logger } from '../utils/Logger';
import { TopNavigation } from '../components/TopNavigation';

@Entry
@Component
struct PersonalInfoPage {
  @State userInfo: UserInfo = {
    nickname: '',
    email: '',
    phone: '',
    avatar: 'ğŸ‘¤',
    joinDate: '',
    recordCount: 0
  };
  @State isEditing: boolean = false;
  @State tempNickname: string = '';
  @State tempEmail: string = '';

  aboutToAppear() {
    this.loadUserInfo();
  }

  async loadUserInfo() {
    try {
      // è¿™é‡Œåº”è¯¥ä»UserManageræˆ–APIè·å–ç”¨æˆ·ä¿¡æ¯
      // æš‚æ—¶ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
      this.userInfo = {
        nickname: 'ä¾¿ä¾¿è®°å½•è€…',
        email: 'user@example.com',
        phone: '138****8888',
        avatar: 'ğŸ‘¤',
        joinDate: '2024-01-01',
        recordCount: 42
      };
      this.tempNickname = this.userInfo.nickname;
      this.tempEmail = this.userInfo.email;
    } catch (error) {
      Logger.error('UI', 'Failed to load user info:', error);
      promptAction.showToast({
        message: 'åŠ è½½ç”¨æˆ·ä¿¡æ¯å¤±è´¥',
        duration: 2000
      });
    }
  }

  async saveUserInfo() {
    try {
      // è¿™é‡Œåº”è¯¥è°ƒç”¨APIä¿å­˜ç”¨æˆ·ä¿¡æ¯
      this.userInfo.nickname = this.tempNickname;
      this.userInfo.email = this.tempEmail;
      this.isEditing = false;
      
      promptAction.showToast({
        message: 'ä¿å­˜æˆåŠŸ',
        duration: 2000
      });
    } catch (error) {
      Logger.error('UI', 'Failed to save user info:', error);
      promptAction.showToast({
        message: 'ä¿å­˜å¤±è´¥',
        duration: 2000
      });
    }
  }

  cancelEdit() {
    this.tempNickname = this.userInfo.nickname;
    this.tempEmail = this.userInfo.email;
    this.isEditing = false;
  }

  build() {
    Column() {
      // é¡¶éƒ¨å¯¼èˆª
      TopNavigation({
        title: 'ä¸ªäººä¿¡æ¯',
        showBackButton: true,
        rightIcon: this.isEditing ? 'ğŸ’¾' : 'âœï¸',
        rightIconClickable: true,
        onRightIconClick: () => {
          if (this.isEditing) {
            this.saveUserInfo();
          } else {
            this.isEditing = true;
          }
        }
      })
      
      // ä¸»è¦å†…å®¹
      Scroll() {
        Column() {
          // å¤´åƒåŒºåŸŸ
          this.AvatarSection()
          
          // åŸºæœ¬ä¿¡æ¯
          this.BasicInfoSection()
          
          // ç»Ÿè®¡ä¿¡æ¯
          this.StatisticsSection()
          
          // æ“ä½œæŒ‰é’®
          if (this.isEditing) {
            this.EditActionsSection()
          }
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 20, bottom: 20 })
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#FFF8E7')
  }

  @Builder
  AvatarSection() {
    Column() {
      Text(this.userInfo.avatar)
        .fontSize(80)
        .margin({ bottom: 16 })
      
      if (this.isEditing) {
        Button('æ›´æ¢å¤´åƒ')
          .fontSize(14)
          .height(32)
          .backgroundColor('#FF9500')
          .onClick(() => {
            promptAction.showToast({
              message: 'æ›´æ¢å¤´åƒåŠŸèƒ½å¼€å‘ä¸­...',
              duration: 2000
            });
          })
      }
    }
    .width('100%')
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .margin({ bottom: 30 })
  }

  @Builder
  BasicInfoSection() {
    Column() {
      Text('åŸºæœ¬ä¿¡æ¯')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#8B4513')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })
      
      Column() {
        // æ˜µç§°
        this.InfoItem('æ˜µç§°', this.userInfo.nickname, this.tempNickname, (value: string) => {
          this.tempNickname = value;
        })
        
        Divider().color('#F0F0F0')
        
        // é‚®ç®±
        this.InfoItem('é‚®ç®±', this.userInfo.email, this.tempEmail, (value: string) => {
          this.tempEmail = value;
        })
        
        Divider().color('#F0F0F0')
        
        // æ‰‹æœºå·ï¼ˆåªè¯»ï¼‰
        this.InfoItem('æ‰‹æœºå·', this.userInfo.phone, '', null, true)
        
        Divider().color('#F0F0F0')
        
        // æ³¨å†Œæ—¶é—´ï¼ˆåªè¯»ï¼‰
        this.InfoItem('æ³¨å†Œæ—¶é—´', this.userInfo.joinDate, '', null, true)
      }
      .width('100%')
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .padding(16)
      .margin({ bottom: 30 })
    }
    .width('100%')
  }

  @Builder
  InfoItem(label: string, value: string, editValue: string, onChange: ((value: string) => void) | null, readonly: boolean = false) {
    Row() {
      Text(label)
        .fontSize(16)
        .fontColor('#8B4513')
        .width(80)
      
      if (this.isEditing && !readonly && onChange) {
        TextInput({ text: editValue })
          .fontSize(16)
          .fontColor('#333333')
          .backgroundColor('#F8F8F8')
          .borderRadius(8)
          .padding({ left: 12, right: 12 })
          .layoutWeight(1)
          .onChange((value: string) => {
            onChange(value);
          })
      } else {
        Text(value)
          .fontSize(16)
          .fontColor('#333333')
          .layoutWeight(1)
          .textAlign(TextAlign.End)
      }
    }
    .width('100%')
    .height(50)
    .alignItems(VerticalAlign.Center)
  }

  @Builder
  StatisticsSection() {
    Column() {
      Text('ä½¿ç”¨ç»Ÿè®¡')
        .fontSize(18)
        .fontWeight(FontWeight.Medium)
        .fontColor('#8B4513')
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: 16 })
      
      Row() {
        Column() {
          Text(this.userInfo.recordCount.toString())
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#FF9500')
          Text('æ€»è®°å½•æ•°')
            .fontSize(14)
            .fontColor('#8B4513')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        
        Column() {
          Text('7')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#34C759')
          Text('æœ¬å‘¨è®°å½•')
            .fontSize(14)
            .fontColor('#8B4513')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
        
        Column() {
          Text('30')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .fontColor('#007AFF')
          Text('è¿ç»­å¤©æ•°')
            .fontSize(14)
            .fontColor('#8B4513')
            .margin({ top: 4 })
        }
        .layoutWeight(1)
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Center)
      }
      .width('100%')
      .height(80)
      .backgroundColor('#FFFFFF')
      .borderRadius(12)
      .margin({ bottom: 30 })
    }
    .width('100%')
  }

  @Builder
  EditActionsSection() {
    Row() {
      Button('å–æ¶ˆ')
        .fontSize(16)
        .height(44)
        .backgroundColor('#F0F0F0')
        .fontColor('#8B4513')
        .layoutWeight(1)
        .onClick(() => {
          this.cancelEdit();
        })
      
      Button('ä¿å­˜')
        .fontSize(16)
        .height(44)
        .backgroundColor('#FF9500')
        .fontColor('#FFFFFF')
        .layoutWeight(1)
        .margin({ left: 16 })
        .onClick(() => {
          this.saveUserInfo();
        })
    }
    .width('100%')
    .margin({ top: 20 })
  }
}

// ç”¨æˆ·ä¿¡æ¯æ¥å£
interface UserInfo {
  nickname: string;
  email: string;
  phone: string;
  avatar: string;
  joinDate: string;
  recordCount: number;
}