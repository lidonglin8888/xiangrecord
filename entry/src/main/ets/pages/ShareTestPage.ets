import { ShareUtils } from '../utils/ShareUtils';
import { common } from '@kit.AbilityKit';
import prompt from '@ohos.prompt';
import router from '@ohos.router';
import { TopNavigation } from '../components/TopNavigation';
import { PoopRecord } from '../model/RecordModel';

@Entry
@Component
struct ShareTestPage {
  private context = getContext(this) as common.UIAbilityContext;
  
  // æµ‹è¯•ç”¨çš„ä¾¿ä¾¿è®°å½•æ•°æ®
  private testRecord: PoopRecord = {
    id: 999,
    date: new Date(),
    time: '14:30',
    mood: 'happy',
    color: 'brown',
    shape: 'normal',
    size: 'medium',
    moisture: 'normal',
    texture: 'smooth',
    smell: 'normal',
    notes: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•åˆ†äº«åŠŸèƒ½çš„ä¾¿ä¾¿è®°å½•',
    userId: '1'
  };

  build() {
    Column() {
      TopNavigation({
        title: 'åˆ†äº«åŠŸèƒ½æµ‹è¯•',
        showBackButton: true,
        onBack: () => {
          router.back();
        }
      })
      
      Scroll() {
        Column() {
          Text('åˆ†äº«åŠŸèƒ½æµ‹è¯•')
            .fontSize(24)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 20 })
          
          // æµ‹è¯•è®°å½•å¡ç‰‡
          Column() {
            Text('æµ‹è¯•è®°å½•')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 12 })
            
            Text(`æ—¶é—´: ${this.testRecord.date} ${this.testRecord.time}`)
              .fontSize(16)
              .margin({ bottom: 8 })
            
            Text(`å¿ƒæƒ…: ğŸ˜Š å¼€å¿ƒ`)
              .fontSize(16)
              .margin({ bottom: 8 })
            
            Text(`ç‰¹å¾: æ£•è‰² Â· æ­£å¸¸ Â· ä¸­ç­‰`)
              .fontSize(16)
              .margin({ bottom: 8 })
            
            Text(`å¤‡æ³¨: ${this.testRecord.notes}`)
              .fontSize(14)
              .fontColor('#666666')
              .margin({ bottom: 16 })
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
          .margin({ bottom: 20 })
          .id('testRecordCard')
          
          // åˆ†äº«æŒ‰é’®ç»„
          Column() {
            Text('åˆ†äº«æµ‹è¯•')
              .fontSize(18)
              .fontWeight(FontWeight.Medium)
              .margin({ bottom: 16 })
            
            Button('åˆ†äº«æ–‡æœ¬')
              .width('100%')
              .height(48)
              .backgroundColor('#007AFF')
              .borderRadius(8)
              .margin({ bottom: 12 })
              .onClick(() => {
                this.shareText();
              })
            
            Button('åˆ†äº«è®°å½•ï¼ˆæ–‡æœ¬ï¼‰')
              .width('100%')
              .height(48)
              .backgroundColor('#34C759')
              .borderRadius(8)
              .margin({ bottom: 12 })
              .onClick(() => {
                this.shareRecordText();
              })
            
            Button('åˆ†äº«è®°å½•ï¼ˆå«æˆªå›¾ï¼‰')
              .width('100%')
              .height(48)
              .backgroundColor('#FF9500')
              .borderRadius(8)
              .margin({ bottom: 12 })
              .onClick(() => {
                this.shareRecordWithImage();
              })
            
            Button('åˆ†äº«ç»„ä»¶æˆªå›¾')
              .width('100%')
              .height(48)
              .backgroundColor('#AF52DE')
              .borderRadius(8)
              .onClick(() => {
                this.shareComponentSnapshot();
              })
          }
          .width('100%')
          .padding(20)
          .backgroundColor('#FFFFFF')
          .borderRadius(12)
        }
        .padding(16)
      }
      .layoutWeight(1)
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#F5F5F5')
  }
  
  async shareText() {
    try {
      await ShareUtils.shareText(
        'è¿™æ˜¯ä¸€æ¡æµ‹è¯•åˆ†äº«åŠŸèƒ½çš„æ–‡æœ¬æ¶ˆæ¯ ğŸ“\n\næ¥è‡ªä¾¿ä¾¿è®°å½•å°åŠ©æ‰‹ ğŸ’©',
        'æµ‹è¯•åˆ†äº«'
      );
    } catch (error) {
      console.error('åˆ†äº«æ–‡æœ¬å¤±è´¥:', error);
      prompt.showToast({
        message: 'åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }
  
  async shareRecordText() {
    try {
      await ShareUtils.shareRecord(this.testRecord);
    } catch (error) {
      console.error('åˆ†äº«è®°å½•å¤±è´¥:', error);
      prompt.showToast({
        message: 'åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }
  
  async shareRecordWithImage() {
    try {
      // shareRecord now only supports text, so we call shareComponentSnapshot directly
      await ShareUtils.shareComponentSnapshot('testRecordCard', 'ä¾¿ä¾¿è®°å½•æˆªå›¾');
    } catch (error) {
      console.error('åˆ†äº«è®°å½•å¤±è´¥:', error);
      prompt.showToast({
        message: 'åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }
  
  async shareComponentSnapshot() {
    try {
      await ShareUtils.shareComponentSnapshot('testRecordCard', 'ä¾¿ä¾¿è®°å½•æˆªå›¾');
    } catch (error) {
      console.error('åˆ†äº«æˆªå›¾å¤±è´¥:', error);
      prompt.showToast({
        message: 'åˆ†äº«å¤±è´¥ï¼Œè¯·é‡è¯•',
        duration: 2000
      });
    }
  }
}