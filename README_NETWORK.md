# 网络配置和故障排除指南

## 概述

本应用支持本地模式和云端模式两种数据存储方式。云端模式需要连接到后端API服务器。

## 网络配置

### 1. 配置服务器地址

编辑 `entry/src/main/ets/config/NetworkConfig.ets` 文件：

```typescript
// 开发环境配置（请根据实际情况修改）
public static readonly DEV_SERVER_IP = '192.168.8.222'; // 替换为你的开发机器IP
public static readonly DEV_SERVER_PORT = '8080';
```

### 2. 获取开发机器IP地址

**Windows:**
```cmd
ipconfig
```
查看 "IPv4 地址" 字段

**macOS/Linux:**
```bash
ifconfig
# 或
ip addr
```
查看 "inet" 地址

### 3. 重要注意事项

- ❌ **不要使用 `localhost` 或 `127.0.0.1`**
  - 在真机或模拟器上，这些地址指向设备本身，无法访问开发机器
- ✅ **使用开发机器的实际IP地址**
  - 确保手机/模拟器和开发机器在同一网络中

## 日志配置

### 启用/禁用日志

在 `NetworkConfig.ets` 中配置：

```typescript
// 日志配置
public static readonly ENABLE_API_LOGS = true;  // 是否启用API日志
public static readonly ENABLE_DEBUG_LOGS = true; // 是否启用调试日志
```

### 日志级别说明

- **API日志**: 显示网络请求的基本信息
- **调试日志**: 显示详细的请求/响应数据
- **错误日志**: 始终显示，包含错误信息和解决建议

## 故障排除

### 1. 连接失败问题

当切换到云端模式显示"连接失败"时，应用会自动执行网络诊断并在控制台输出详细报告。

### 2. 常见问题和解决方案

#### 问题1: 使用了localhost地址
**现象**: 网络诊断显示"检测到使用localhost地址"
**解决**: 修改 `NetworkConfig.ets` 中的 `DEV_SERVER_IP` 为实际IP地址

#### 问题2: 无法连接到服务器
**现象**: 网络诊断显示"无法连接到服务器"
**解决步骤**:
1. 确认后端服务已启动
2. 检查IP地址和端口是否正确
3. 确认防火墙没有阻止连接
4. 确认设备和开发机器在同一网络

#### 问题3: API端点响应异常
**现象**: 服务器连通但API返回错误
**解决步骤**:
1. 检查API路径是否正确
2. 确认后端API接口已正确实现
3. 查看后端服务器日志

#### 问题4: 看不到控制台日志
**可能原因**:
1. 日志被禁用了
2. IDE控制台过滤设置
3. 日志级别设置过高

**解决步骤**:
1. 确认 `NetworkConfig.ets` 中日志开关已启用
2. 检查IDE控制台的过滤设置
3. 查看设备日志（如果在真机上运行）

### 3. 网络诊断工具

应用内置了自动网络诊断功能，会检查：
- 服务器连通性
- API端点可用性
- 网络配置问题
- 常见错误模式

### 4. 手动网络测试

可以使用以下命令手动测试网络连接：

```bash
# 测试服务器连通性
ping 192.168.8.222

# 测试端口连通性
telnet 192.168.8.222 8080

# 测试API端点
curl http://192.168.8.222:8080/api/records
```

## 开发环境设置

### 1. 后端服务器启动

确保后端Spring Boot应用已启动：
```bash
cd backend
mvn spring-boot:run
```

### 2. 防火墙配置

**Windows防火墙**:
1. 打开"Windows Defender 防火墙"
2. 点击"允许应用或功能通过Windows Defender防火墙"
3. 添加Java应用或端口8080

**macOS防火墙**:
```bash
sudo pfctl -f /etc/pf.conf
```

### 3. 网络环境检查

确保开发机器和测试设备在同一网络：
- 连接同一WiFi网络
- 或使用USB调试连接
- 避免使用VPN或代理

## 生产环境配置

### 1. 服务器配置

生产环境需要配置：
- 域名和SSL证书
- 负载均衡
- 数据库连接池
- 缓存配置

### 2. 安全配置

- 启用HTTPS
- 配置CORS策略
- API访问限制
- 数据加密传输

### 3. 监控和日志

- 应用性能监控
- 错误日志收集
- 网络请求统计
- 用户行为分析

## 常见错误代码

| 错误代码 | 描述 | 解决方案 |
|---------|------|----------|
| NETWORK_ERROR | 网络连接失败 | 检查网络配置和服务器状态 |
| TIMEOUT_ERROR | 请求超时 | 检查网络速度和服务器响应时间 |
| SERVER_ERROR | 服务器内部错误 | 查看后端服务器日志 |
| AUTH_ERROR | 认证失败 | 检查API密钥和权限配置 |
| PARSE_ERROR | 数据解析失败 | 检查API响应格式 |

## 性能优化

### 1. 网络请求优化
- 使用连接池
- 启用请求缓存
- 压缩传输数据
- 批量请求合并

### 2. 错误重试机制
- 指数退避重试
- 最大重试次数限制
- 网络状态检测
- 离线模式支持

### 3. 数据同步策略
- 增量同步
- 冲突解决
- 本地缓存
- 后台同步

---

**提示**: 如果遇到网络问题，建议先切换到本地模式进行开发和测试，待网络配置正确后再切换到云端模式。